<UserControl x:Class="BeamNG_LevelCleanUp.Viewer3D.HelixViewportControl"
         xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
         xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
         xmlns:hx="http://helix-toolkit.org/wpf/SharpDX"
         Background="#1E1E2E">
    
<Grid>
    <Grid.RowDefinitions>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
    </Grid.ColumnDefinitions>
        
    <!-- 3D Viewport with mouse events for mesh selection -->
    <hx:Viewport3DX 
        x:Name="Viewport"
        Grid.Row="0"
        Grid.Column="0"
        BackgroundColor="#1E1E2E"
        ShowCoordinateSystem="True"
        CoordinateSystemLabelForeground="White"
        TextBrush="White"
        EnableSwapChainRendering="True"
        FXAALevel="Medium"
        MSAA="Four"
        MouseLeftButtonDown="Viewport_OnMouseLeftButtonDown">
            
            <!-- Camera -->
            <hx:Viewport3DX.Camera>
                <hx:PerspectiveCamera 
                    Position="5,5,5" 
                    LookDirection="-1,-1,-1" 
                    UpDirection="0,0,1"
                    NearPlaneDistance="0.1"
                    FarPlaneDistance="10000"/>
            </hx:Viewport3DX.Camera>
            
            <!-- Improved Lighting Setup for even illumination -->
            <!-- Strong ambient light - provides bright base illumination to all surfaces -->
            <hx:AmbientLight3D Color="#A0A0A0"/>
            
            <!-- Soft directional lights from multiple angles for even coverage -->
            <!-- Key light - from front-top-right, moderate intensity -->
            <hx:DirectionalLight3D Direction="-1,-1,-0.5" Color="#909090"/>
            
            <!-- Fill light - from front-top-left, similar intensity for balance -->
            <hx:DirectionalLight3D Direction="1,-1,-0.5" Color="#808080"/>
            
            <!-- Back lights - prevent dark back sides -->
            <hx:DirectionalLight3D Direction="-1,1,-0.3" Color="#707070"/>
            <hx:DirectionalLight3D Direction="1,1,-0.3" Color="#707070"/>
            
            <!-- Top light - gentle overhead illumination -->
            <hx:DirectionalLight3D Direction="0,0,-1" Color="#606060"/>
            
            <!-- Bottom fill - prevents completely dark undersides -->
            <hx:DirectionalLight3D Direction="0,0,1" Color="#505050"/>
            
        </hx:Viewport3DX>
        
        <!-- Right Side Panels Container -->
        <ScrollViewer Grid.Row="0" Grid.Column="1" 
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      Background="#2D2D3D">
            <StackPanel Width="280">
                
                <!-- Lighting Control Panel (collapsible) -->
                <Expander Header="Lighting" 
                          ExpandDirection="Down"
                          IsExpanded="False"
                          Background="#2D2D3D"
                          Foreground="White"
                          BorderBrush="#3D3D4D"
                          BorderThickness="0,0,0,1">
                    <Border Background="#252535" Padding="12">
                        <StackPanel>
                            <!-- Real-time Light Controls Section -->
                            <TextBlock Text="SCENE LIGHTS" Foreground="#88CCFF" FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                            
                            <!-- Ambient Light Slider (real-time) -->
                            <TextBlock Text="Ambient Light" Foreground="#AAA" FontSize="11"/>
                            <Grid Margin="0,2,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="SliderAmbient" 
                                        Minimum="0" Maximum="1" Value="0.11" 
                                        TickFrequency="0.1" IsSnapToTickEnabled="False"
                                        ValueChanged="SliderAmbient_ValueChanged"/>
                                <TextBlock Grid.Column="1" x:Name="TxtAmbientValue" 
                                           Text="0.11" Foreground="White" 
                                           HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>
                            
                            <!-- Directional Light Slider (real-time) -->
                            <TextBlock Text="Directional Light" Foreground="#AAA" FontSize="11"/>
                            <Grid Margin="0,2,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="SliderDirectional" 
                                        Minimum="0" Maximum="2" Value="0.65" 
                                        TickFrequency="0.1" IsSnapToTickEnabled="False"
                                        ValueChanged="SliderDirectional_ValueChanged"/>
                                <TextBlock Grid.Column="1" x:Name="TxtDirectionalValue" 
                                           Text="0.65" Foreground="White" 
                                           HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>
                            
                            <!-- Separator -->
                            <Border Height="1" Background="#3D3D4D" Margin="0,4,0,12"/>
                            
                            <!-- Material Properties Section (requires reload) -->
                            <TextBlock Text="MATERIAL PROPERTIES" Foreground="#FFCC88" FontSize="10" FontWeight="Bold" Margin="0,0,0,4"/>
                            <TextBlock Text="Changes require model reload" Foreground="#666" FontSize="9" FontStyle="Italic" Margin="0,0,0,8"/>
                            
                            <!-- Material Diffuse Slider -->
                            <TextBlock Text="Material Diffuse" Foreground="#AAA" FontSize="11"/>
                            <Grid Margin="0,2,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="SliderDiffuse" 
                                        Minimum="0" Maximum="1" Value="1.0" 
                                        TickFrequency="0.1" IsSnapToTickEnabled="False"
                                        ValueChanged="SliderDiffuse_ValueChanged"/>
                                <TextBlock Grid.Column="1" x:Name="TxtDiffuseValue" 
                                           Text="1.00" Foreground="White" 
                                           HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>
                            
                            <!-- Material Ambient Slider -->
                            <TextBlock Text="Material Ambient" Foreground="#AAA" FontSize="11"/>
                            <Grid Margin="0,2,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <Slider x:Name="SliderMaterialAmbient" 
                                        Minimum="0" Maximum="1" Value="0.0" 
                                        TickFrequency="0.1" IsSnapToTickEnabled="False"
                                        ValueChanged="SliderMaterialAmbient_ValueChanged"/>
                                <TextBlock Grid.Column="1" x:Name="TxtMaterialAmbientValue" 
                                           Text="0.00" Foreground="White" 
                                           HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>
                            
                            <!-- Separator -->
                            <Border Height="1" Background="#3D3D4D" Margin="0,4,0,12"/>
                            
                            <!-- Preset Buttons -->
                            <TextBlock Text="PRESETS" Foreground="#88FF88" FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                            <WrapPanel>
                                <Button Content="Low" Click="BtnLowLight_Click" 
                                        Padding="12,6" Margin="0,0,4,4"
                                        Background="#3D3D4D" Foreground="White" BorderBrush="#4D4D5D"/>
                                <Button Content="Medium" Click="BtnMediumLight_Click"
                                        Padding="12,6" Margin="0,0,4,4"
                                        Background="#3D3D4D" Foreground="White" BorderBrush="#4D4D5D"/>
                                <Button Content="High" Click="BtnHighLight_Click"
                                        Padding="12,6" Margin="0,0,4,4"
                                        Background="#3D3D4D" Foreground="White" BorderBrush="#4D4D5D"/>
                            </WrapPanel>
                            
                            <!-- Reload Button -->
                            <Button Content="Reload Model" Click="BtnReloadModel_Click"
                                    Padding="12,8" Margin="0,8,0,0"
                                    Background="#4D6D4D" Foreground="White" BorderBrush="#5D7D5D"
                                    HorizontalAlignment="Stretch"
                                    ToolTip="Reload model with new material settings"/>
                        </StackPanel>
                    </Border>
                </Expander>
                
                <!-- Model Options Panel (collapsible) -->
                <Expander Header="Model Options" 
                          ExpandDirection="Down"
                          IsExpanded="False"
                          Background="#2D2D3D"
                          Foreground="White"
                          BorderBrush="#3D3D4D"
                          BorderThickness="0,0,0,1">
                    <Border Background="#252535" Padding="12">
                        <StackPanel>
                            <TextBlock Text="LOD FILTERING" Foreground="#88CCFF" FontSize="10" FontWeight="Bold" Margin="0,0,0,8"/>
                            
                            <!-- LOD Toggle Button -->
                            <ToggleButton x:Name="BtnToggleLod"
                                          Content="Show Highest LOD Only"
                                          IsChecked="True"
                                          Click="BtnToggleLod_Click"
                                          Padding="12,8"
                                          HorizontalAlignment="Stretch"
                                          ToolTip="When ON: Shows only highest detail LOD and filters collision meshes.&#x0a;When OFF: Shows all meshes including all LOD levels and collision geometry.">
                                <ToggleButton.Style>
                                    <Style TargetType="ToggleButton">
                                        <Setter Property="Background" Value="#4D6D4D"/>
                                        <Setter Property="Foreground" Value="White"/>
                                        <Setter Property="BorderBrush" Value="#5D7D5D"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsChecked" Value="False">
                                                <Setter Property="Background" Value="#6D4D4D"/>
                                                <Setter Property="BorderBrush" Value="#7D5D5D"/>
                                                <Setter Property="Content" Value="Show All LODs &amp; Collision"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>
                            
                            <TextBlock Text="Toggle filters collision meshes and lower detail LODs" 
                                       Foreground="#666" FontSize="9" FontStyle="Italic" 
                                       TextWrapping="Wrap" Margin="0,4,0,0"/>
                            
                            <!-- Separator -->
                            <Border Height="1" Background="#3D3D4D" Margin="0,12,0,12"/>
                            
                            <!-- Texture Maps Section -->
                            <TextBlock Text="TEXTURE MAPS" Foreground="#FFCC88" FontSize="10" FontWeight="Bold" Margin="0,0,0,4"/>
                            <TextBlock Text="Select which texture maps to load" Foreground="#666" FontSize="9" FontStyle="Italic" Margin="0,0,0,8"/>
                            
                            <!-- Texture Map Checkboxes -->
                            <CheckBox x:Name="ChkBaseColorMap" 
                                      Content="Base Color (Albedo/Diffuse)" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Primary color texture that defines surface appearance"/>
                            <CheckBox x:Name="ChkOpacityMap" 
                                      Content="Opacity (Alpha)" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Controls transparency - merged into base color alpha channel"/>
                            <CheckBox x:Name="ChkNormalMap" 
                                      Content="Normal Map" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Adds surface detail without additional geometry"/>
                            <CheckBox x:Name="ChkRoughnessMap" 
                                      Content="Roughness (PBR)" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Controls surface roughness/smoothness (PBR only)"/>
                            <CheckBox x:Name="ChkMetallicMap" 
                                      Content="Metallic (PBR)" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Controls metallic appearance (PBR only)"/>
                            <CheckBox x:Name="ChkAmbientOcclusionMap" 
                                      Content="Ambient Occlusion" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Adds shadowing in crevices and corners (PBR only)"/>
                            <CheckBox x:Name="ChkEmissiveMap" 
                                      Content="Emissive (Glow)" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Makes surfaces appear to emit light"/>
                            <CheckBox x:Name="ChkSpecularMap" 
                                      Content="Specular (Phong)" 
                                      IsChecked="True"
                                      Foreground="White" 
                                      Margin="0,4,0,0"
                                      ToolTip="Controls highlight intensity (Phong materials only)"/>
                            
                            <!-- Reload with Texture Settings Button -->
                            <Button Content="Reload with Texture Settings" 
                                    Click="BtnReloadTextureSettings_Click"
                                    Padding="12,8" Margin="0,12,0,0"
                                    Background="#4D6D4D" Foreground="White" BorderBrush="#5D7D5D"
                                    HorizontalAlignment="Stretch"
                                    ToolTip="Apply texture map settings and reload the model"/>
                        </StackPanel>
                    </Border>
                </Expander>
                
                <!-- Meshes Control Panel (collapsible) -->
                <Expander Header="Meshes" 
                          ExpandDirection="Down"
                          IsExpanded="False"
                          Background="#2D2D3D"
                          Foreground="White"
                          BorderBrush="#3D3D4D"
                          BorderThickness="0,0,0,1">
                    <Border Background="#252535" Padding="8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto" MaxHeight="400"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Toggle Buttons -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                                <Button x:Name="BtnShowAll" Content="Show All" 
                                        Click="BtnShowAll_Click"
                                        Padding="8,4" Margin="0,0,4,0"
                                        Background="#4D4D5D" Foreground="White" BorderBrush="#5D5D6D"/>
                                <Button x:Name="BtnHideNoTextures" Content="Hide No Textures" 
                                        Click="BtnHideNoTextures_Click"
                                        Padding="8,4" Margin="0,0,4,0"
                                        Background="#4D4D5D" Foreground="White" BorderBrush="#5D5D6D"/>
                            </StackPanel>
                            
                            <!-- Mesh List -->
                            <ListView x:Name="MeshListView" 
                                      Grid.Row="1"
                                      MaxHeight="380"
                                      Background="#252535"
                                      Foreground="White"
                                      BorderThickness="0"
                                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                                      ScrollViewer.CanContentScroll="True">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="2">
                                            <CheckBox IsChecked="{Binding IsVisible, Mode=TwoWay}"
                                                      VerticalAlignment="Center"
                                                      Margin="0,0,8,0"/>
                                            <StackPanel Orientation="Vertical">
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           Foreground="White"
                                                           FontWeight="SemiBold"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding DisplayName}"/>
                                                <TextBlock Text="{Binding MaterialDisplayName}" 
                                                           Foreground="#AAA"
                                                           FontSize="11"
                                                           TextTrimming="CharacterEllipsis"
                                                           ToolTip="{Binding MaterialDisplayName}"/>
                                                <TextBlock Foreground="#888" FontSize="10">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding HasTextures}" Value="True">
                                                                    <Setter Property="Text" Value="[+] Has textures"/>
                                                                    <Setter Property="Foreground" Value="#88CC88"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding HasTextures}" Value="False">
                                                                    <Setter Property="Text" Value="[-] No textures"/>
                                                                    <Setter Property="Foreground" Value="#CC8888"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </StackPanel>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Padding" Value="4"/>
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                        <Setter Property="BorderThickness" Value="2"/>
                                        <Setter Property="BorderBrush" Value="Transparent"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#3D3D4D"/>
                                            </Trigger>
                                            <!-- Highlight selected mesh in panel -->
                                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                <Setter Property="Background" Value="#4A4A2A"/>
                                                <Setter Property="BorderBrush" Value="#FFD700"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListView.ItemContainerStyle>
                            </ListView>
                        </Grid>
                    </Border>
                </Expander>
                
            </StackPanel>
        </ScrollViewer>
        
        <!-- Help Popup (overlay) -->
        <Popup x:Name="HelpPopup" 
               PlacementTarget="{Binding ElementName=BtnHelp}" 
               Placement="Top"
               StaysOpen="False"
               AllowsTransparency="True">
            <Border Background="#2D2D3D" 
                    BorderBrush="#5D5D6D" 
                    BorderThickness="1" 
                    CornerRadius="8"
                    Padding="16"
                    MaxWidth="420">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" Opacity="0.5" ShadowDepth="3"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock Text="3D Viewport Controls" 
                               FontSize="16" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               Margin="0,0,0,12"/>
                    
                    <!-- Rotate -->
                    <TextBlock Text="[R] Rotate" FontWeight="SemiBold" Foreground="#88CCFF" Margin="0,0,0,4"/>
                    <TextBlock Foreground="#CCC" TextWrapping="Wrap" Margin="16,0,0,8">
                        <Run Text="- Arrow keys Left/Right - rotate left/right"/>
                        <LineBreak/><Run Text="- Arrow keys Up/Down - rotate up/down"/>
                        <LineBreak/><Run Text="- Mouse right button + drag"/>
                    </TextBlock>
                    
                    <!-- Move -->
                    <TextBlock Text="[M] Move" FontWeight="SemiBold" Foreground="#88CCFF" Margin="0,0,0,4"/>
                    <TextBlock Foreground="#CCC" TextWrapping="Wrap" Margin="16,0,0,8">
                        <Run Text="- W/S - move forward/backward"/>
                        <LineBreak/><Run Text="- A/D - move left/right"/>
                        <LineBreak/><Run Text="- Q/Z - move up/down"/>
                    </TextBlock>
                    
                    <!-- Pan -->
                    <TextBlock Text="[P] Pan" FontWeight="SemiBold" Foreground="#88CCFF" Margin="0,0,0,4"/>
                    <TextBlock Foreground="#CCC" TextWrapping="Wrap" Margin="16,0,0,8">
                        <Run Text="- Shift + mouse right button + drag"/>
                    </TextBlock>
                    
                    <!-- Zoom -->
                    <TextBlock Text="[Z] Zoom" FontWeight="SemiBold" Foreground="#88CCFF" Margin="0,0,0,4"/>
                    <TextBlock Foreground="#CCC" TextWrapping="Wrap" Margin="16,0,0,8">
                        <Run Text="- Mouse wheel scroll"/>
                        <LineBreak/><Run Text="- Ctrl + mouse right button + drag"/>
                    </TextBlock>
                    
                    <!-- Field of View -->
                    <TextBlock Text="[F] Change Field of View" FontWeight="SemiBold" Foreground="#88CCFF" Margin="0,0,0,4"/>
                    <TextBlock Foreground="#CCC" TextWrapping="Wrap" Margin="16,0,0,8">
                        <Run Text="- Alt + mouse right button + drag"/>
                    </TextBlock>
                    
                    <!-- Selection -->
                    <TextBlock Text="[S] Selection" FontWeight="SemiBold" Foreground="#88CCFF" Margin="0,0,0,4"/>
                    <TextBlock Foreground="#CCC" TextWrapping="Wrap" Margin="16,0,0,0">
                        <Run Text="- Left click on mesh to select"/>
                        <LineBreak/><Run Text="- Selected mesh is highlighted in yellow"/>
                    </TextBlock>
                </StackPanel>
            </Border>
        </Popup>
        
        <!-- Status Bar -->
        <Border Grid.Row="1" Grid.ColumnSpan="2" Background="#2D2D3D" Padding="8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock x:Name="StatusText" 
                           Grid.Column="0"
                           Foreground="White" 
                           Text="Ready"
                           VerticalAlignment="Center"/>
                <Button x:Name="BtnHelp" 
                        Grid.Column="1"
                        Content="?" 
                        Click="BtnHelp_Click"
                        ToolTip="Show viewport controls help"
                        Background="#4D4D5D" 
                        Foreground="White" 
                        BorderBrush="#5D5D6D"
                        Padding="10,4"
                        FontSize="14"
                        FontWeight="Bold"
                        Cursor="Hand"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
