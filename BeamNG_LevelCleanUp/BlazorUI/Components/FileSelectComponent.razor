@using DialogResult = System.Windows.Forms.DialogResult
@if (!string.IsNullOrEmpty(Title))
{
    <MudText Typo="Typo.h6">@Title</MudText>
}
@if (!string.IsNullOrEmpty(Description))
{
    <MudText>@Description</MudText>
}
@if (!string.IsNullOrEmpty(_selectedFile))
{
    <MudListItem T="string" Icon="@Icons.Material.Filled.AttachFile" @key="@_selectedFile">
        @_selectedFile
    </MudListItem>
}
@if (!SelectFolder)
{
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.FileOpen"
               OnClick="OpenFile"
               Disabled="@Disabled">
        Select File
    </MudButton>
}
else
{
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.FolderOpen"
               OnClick="OpenFolder"
               Disabled="@Disabled">
        Select Folder
    </MudButton>
}

@code {
    [Parameter] public string Title { get; set; }
    [Parameter] public string Description { get; set; }
    [Parameter] public EventCallback<string> OnFileSelected { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool SelectFolder { get; set; }
    private string _selectedFile { get; set; } = string.Empty;

    private async Task OpenFile()
    {
        try
        {
            // Run dialog on STA thread to avoid SEHException
            string? selectedPath = null;
            var staThread = new Thread(() =>
            {
                using var dialog = new OpenFileDialog();
                dialog.Filter = "Zipfiles (*.zip)|*.zip";
                dialog.FileName = string.Empty;
                if (dialog.ShowDialog() == DialogResult.OK)
                {
                    selectedPath = dialog.FileName;
                }
            });
            staThread.SetApartmentState(ApartmentState.STA);
            staThread.Start();
            staThread.Join();

            if (!string.IsNullOrEmpty(selectedPath))
            {
                _selectedFile = selectedPath;
                await OnFileSelected.InvokeAsync(_selectedFile);
            }
        }
        catch (Exception ex)
        {
            throw;
        }
    }

    private async Task OpenFolder()
    {
        try
        {
            // Run dialog on STA thread to avoid SEHException
            string? selectedPath = null;
            var staThread = new Thread(() =>
            {
                using var dialog = new FolderBrowserDialog();
                if (dialog.ShowDialog() == DialogResult.OK)
                {
                    selectedPath = dialog.SelectedPath;
                }
            });
            staThread.SetApartmentState(ApartmentState.STA);
            staThread.Start();
            staThread.Join();

            if (!string.IsNullOrEmpty(selectedPath))
            {
                _selectedFile = selectedPath;
                await OnFileSelected.InvokeAsync(_selectedFile);
            }
        }
        catch (Exception ex)
        {
            throw;
        }
    }

}