@using Microsoft.JSInterop
@using BeamNgTerrainPoc.Terrain.GeoTiff
@using System.Globalization

<MudPaper Class="pa-4" Elevation="2">
<MudText Typo="Typo.subtitle1" Class="mb-3">@Title</MudText>
    
@if (OriginalWidth > 0 && OriginalHeight > 0)
    {
        <MudGrid Spacing="2">
            <!-- Left column: Info and coordinates -->
            <MudItem xs="12" md="5">
                <!-- Source Info -->
                <div class="d-flex align-center gap-2 mb-2">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        <strong>Source:</strong> @OriginalWidth × @OriginalHeight px
                        (@GetSourceRealWorldSize())
                    </MudText>
                </div>

                <!-- Selection Info -->
                <div class="d-flex align-center gap-2 mb-2">
                    <MudText Typo="Typo.body2">
                        <strong>Selection:</strong> @SelectionWidthPixels × @SelectionHeightPixels px
                        (@GetSelectionRealWorldSize())
                    </MudText>
                    @if (NeedsSelection)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Crop" Class="ma-0">
                            Subset
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Check" Class="ma-0">
                            Full Image
                        </MudChip>
                    }
                </div>

                <!-- Pixel Offset -->
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                    Pixel offset: (@CropOffsetX, @CropOffsetY)
                </MudText>

                <!-- Selection Bounding Box with Copy -->
                @if (_selectionBoundingBox != null)
                {
                    <MudPaper Class="pa-2 mb-2" Elevation="0" Outlined="true">
                        <div class="d-flex align-center justify-space-between mb-1">
                            <MudText Typo="Typo.caption"><strong>Selection Coordinates (WGS84)</strong></MudText>
                            <MudTooltip Text="Copy coordinates for Google Maps">
                                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                               Size="Size.Small"
                                               OnClick="CopyCoordinatesToClipboard" />
                            </MudTooltip>
                        </div>
                        <MudText Typo="Typo.caption" Style="font-family: monospace;">
                            SW: @_selectionBoundingBox.MinLatitude.ToString("F6")°, @_selectionBoundingBox.MinLongitude.ToString("F6")°
                        </MudText>
                        <MudText Typo="Typo.caption" Style="font-family: monospace;">
                            NE: @_selectionBoundingBox.MaxLatitude.ToString("F6")°, @_selectionBoundingBox.MaxLongitude.ToString("F6")°
                        </MudText>
                        <MudText Typo="Typo.caption" Style="font-family: monospace;" Color="Color.Secondary">
                            Center: @_selectionBoundingBox.Center.Latitude.ToString("F6")°, @_selectionBoundingBox.Center.Longitude.ToString("F6")°
                        </MudText>
                    </MudPaper>
                }

                <!-- Google Maps Link -->
                @if (_selectionBoundingBox != null)
                {
                    <MudButton Variant="Variant.Text"
                               Size="Size.Small"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Map"
                               OnClick="OpenInGoogleMaps">
                        View in Google Maps
                    </MudButton>
                }
                
                <!-- OSM Map Toggle -->
                @if (OriginalBoundingBox != null)
                {
                    <div class="d-flex align-center gap-2 mt-2">
                        <MudSwitch T="bool" @bind-Value="_showOsmBackground" 
                                   Color="Color.Primary" 
                                   Size="Size.Small"
                                   Label="Show OSM Map" />
                    </div>
                }
            </MudItem>

            <!-- Right column: Interactive Minimap -->
            <MudItem xs="12" md="7">
                <div class="d-flex align-center justify-space-between mb-2">
                    <MudText Typo="Typo.body2">
                        <MudIcon Icon="@Icons.Material.Filled.PanTool" Size="Size.Small" Class="mr-1" />
                        Drag to position selection
                    </MudText>
                    @if (OriginalBoundingBox != null)
                    {
                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Fullscreen"
                                   OnClick="OpenEnlargedView">
                            Enlarge
                        </MudButton>
                    }
                </div>
                <div class="minimap-container" style="@GetMinimapContainerStyle()">
                    <div class="minimap-source" 
                         style="@GetMinimapSourceStyle()"
                         @ref="_minimapElement"
                         @onmousedown="OnMinimapMouseDown"
                         @onmousemove="OnMinimapMouseMove"
                         @onmouseup="OnMinimapMouseUp"
                         @onmouseleave="OnMinimapMouseLeave">
                        
                        @* OSM tile background using shared component *@
                        @if (OriginalBoundingBox != null)
                        {
                            <OsmMapTileBackground BoundingBox="@OriginalBoundingBox"
                                                  DisplayWidth="@GetMinimapDisplayWidth()"
                                                  DisplayHeight="@GetMinimapDisplayHeight()"
                                                  IsVisible="@_showOsmBackground"
                                                  Opacity="@_mapOpacity"
                                                  ShowAttribution="false"
                                                  ZIndex="1" />
                        }
                        
                        <!-- Selection rectangle -->
                        <div class="minimap-selection @(_isDragging ? "dragging" : "")"
                             style="@GetSelectionStyle()">
                            <MudIcon Icon="@Icons.Material.Filled.OpenWith" 
                                     Size="Size.Small" 
                                     Style="color: white; opacity: 0.8;" />
                        </div>
                        <!-- Grid overlay for reference -->
                        <div class="minimap-grid"></div>
                    </div>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 text-center">
                    @if (NeedsSelection)
                    {
                        <span>Extracting @GetSelectionRealWorldSize() from @GetSourceRealWorldSize() source</span>
                    }
                    else
                    {
                        <span>Using full source image</span>
                    }
                </MudText>
                @if (_showOsmBackground)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-center">
                        Map data © <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors
                    </MudText>
                }
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Select a GeoTIFF file to configure extraction region.
        </MudText>
    }
</MudPaper>

@* Enlarged View Overlay *@
@if (_showEnlargedView && OriginalBoundingBox != null)
{
    <MudOverlay Visible="true" DarkBackground="true" ZIndex="9999" OnClick="CloseEnlargedView">
        <div class="enlarged-overlay-container" @onclick:stopPropagation="true">
            <MudPaper Class="pa-4" Elevation="8" Style="max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column;">
                @* Header *@
                <div class="d-flex align-center justify-space-between mb-3">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.Crop" Class="mr-2" />
                        GeoTIFF Selection - Enlarged View
                    </MudText>
                    <div class="d-flex align-center gap-2">
                        @* Map opacity slider *@
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Map:</MudText>
                        <MudSlider T="float" @bind-Value="_mapOpacity"
                                   Size="Size.Small"
                                   Min="0.0f" Max="1.0f" Step="0.1f"
                                   Style="width: 100px;"
                                   Immediate="true" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="width: 36px;">@(_mapOpacity.ToString("P0"))</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                       Size="Size.Medium"
                                       OnClick="CloseEnlargedView" />
                    </div>
                </div>
                
                @* Info bar *@
                <div class="d-flex align-center gap-4 mb-3">
                    <MudText Typo="Typo.body2">
                        <strong>Source:</strong> @OriginalWidth × @OriginalHeight px (@GetSourceRealWorldSize())
                    </MudText>
                    <MudText Typo="Typo.body2">
                        <strong>Selection:</strong> @SelectionWidthPixels × @SelectionHeightPixels px (@GetSelectionRealWorldSize())
                    </MudText>
                    <MudText Typo="Typo.body2">
                        <strong>Offset:</strong> (@CropOffsetX, @CropOffsetY)
                    </MudText>
                    @if (_selectionBoundingBox != null)
                    {
                        <MudText Typo="Typo.body2">
                            <strong>Center:</strong> @_selectionBoundingBox.Center.Latitude.ToString("F4")°, @_selectionBoundingBox.Center.Longitude.ToString("F4")°
                        </MudText>
                    }
                </div>
                
                @* Large interactive map *@
                <div class="enlarged-map-container" style="flex: 1; min-height: 0;">
                    <div class="enlarged-map-source"
                         style="@GetEnlargedMapStyle()"
                         @onmousedown="OnEnlargedMouseDown"
                         @onmousemove="OnEnlargedMouseMove"
                         @onmouseup="OnEnlargedMouseUp"
                         @onmouseleave="OnEnlargedMouseLeave">
                        
                        @* OSM tile background - larger size for more detail *@
                        <OsmMapTileBackground BoundingBox="@OriginalBoundingBox"
                                              DisplayWidth="@GetEnlargedDisplayWidth()"
                                              DisplayHeight="@GetEnlargedDisplayHeight()"
                                              IsVisible="true"
                                              Opacity="@_mapOpacity"
                                              MaxTiles="100"
                                              ShowAttribution="false"
                                              ZIndex="1" />
                        
                        @* Selection rectangle *@
                        <div class="minimap-selection @(_isDraggingEnlarged ? "dragging" : "")"
                             style="@GetEnlargedSelectionStyle()">
                            <MudIcon Icon="@Icons.Material.Filled.OpenWith" 
                                     Size="Size.Medium" 
                                     Style="color: white; opacity: 0.9;" />
                        </div>
                        
                        @* Grid overlay *@
                        <div class="minimap-grid"></div>
                    </div>
                </div>
                
                @* Footer *@
                <div class="d-flex align-center justify-space-between mt-3">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        <MudIcon Icon="@Icons.Material.Filled.PanTool" Size="Size.Small" Class="mr-1" />
                        Drag the selection rectangle to reposition. Map data © OpenStreetMap contributors.
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="CloseEnlargedView"
                               StartIcon="@Icons.Material.Filled.Check">
                        Done
                    </MudButton>
                </div>
            </MudPaper>
        </div>
    </MudOverlay>
}

<style>
    .minimap-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        min-height: 200px;
    }
    
    .minimap-source {
        position: relative;
        background: linear-gradient(135deg, rgba(100, 100, 100, 0.3) 0%, rgba(60, 60, 60, 0.4) 100%);
        border: 2px solid rgba(100, 100, 100, 0.5);
        border-radius: 2px;
        cursor: crosshair;
        overflow: hidden;
    }
    
    .minimap-selection {
        position: absolute;
        background: var(--mud-palette-primary);
        opacity: 0.5;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        border-radius: 2px;
        box-shadow: 0 0 8px rgba(0,0,0,0.5);
        cursor: move;
        transition: opacity 0.1s, box-shadow 0.1s;
        z-index: 10;
    }
    
    .minimap-selection:hover {
        opacity: 0.65;
        box-shadow: 0 0 12px rgba(0,0,0,0.6);
    }
    
    .minimap-selection.dragging {
        opacity: 0.75;
        box-shadow: 0 0 16px rgba(var(--mud-palette-primary-rgb), 0.8);
    }
    
    .minimap-grid {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 25% 25%;
        pointer-events: none;
        z-index: 5;
    }
    
    .text-center {
        text-align: center;
    }
    
    /* Enlarged overlay styles */
    .enlarged-overlay-container {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        padding: 20px;
    }
    
    .enlarged-map-container {
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .enlarged-map-source {
        position: relative;
        background: linear-gradient(135deg, rgba(60, 60, 80, 0.5) 0%, rgba(40, 40, 60, 0.6) 100%);
        border: 2px solid rgba(100, 100, 100, 0.5);
        border-radius: 4px;
        cursor: crosshair;
        overflow: hidden;
    }
</style>
