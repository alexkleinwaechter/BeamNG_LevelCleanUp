@using DialogResult = System.Windows.Forms.DialogResult
@using BeamNgTerrainPoc.Terrain.Models
@using BeamNgTerrainPoc.Examples
@using static BeamNG_LevelCleanUp.BlazorUI.Components.RoadParameterTooltips

<MudExpansionPanel Text="@GetPanelTitle()" 
                   IsInitiallyExpanded="false"
                   Class="mb-2">
    <TitleContent>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small"/>
            <MudText Typo="Typo.body1">
                <strong>[@Material.Order]</strong> @Material.InternalName
            </MudText>
            @if (Material.HasLayerMap)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                    Layer Map
                </MudChip>
            }
            @if (Material.IsRoadMaterial)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                    Road
                </MudChip>
                @if (GetValidationErrorCount() > 0)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">
                        <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Class="mr-1"/>
                        @GetValidationErrorCount() Error@(GetValidationErrorCount() > 1 ? "s" : "")
                    </MudChip>
                }
                else if (GetValidationWarningCount() > 0)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1"/>
                        @GetValidationWarningCount() Warning@(GetValidationWarningCount() > 1 ? "s" : "")
                    </MudChip>
                }
            }
        </div>
    </TitleContent>
    <ChildContent>
        <MudGrid Spacing="2" Class="pa-2">
            <!-- Layer Map Selection -->
            <MudItem xs="12">
                <MudText Typo="Typo.subtitle2" Class="mb-2">Layer Map (Optional)</MudText>
                <div class="d-flex align-center gap-2">
                    <MudTextField @bind-Value="Material.LayerMapPath" 
                                 Label="Layer Map Path" 
                                 Variant="Variant.Outlined"
                                 ReadOnly="true"
                                 Placeholder="No layer map selected"
                                 Class="flex-grow-1"/>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Image"
                              OnClick="SelectLayerMap">
                        Browse
                    </MudButton>
                    @if (!string.IsNullOrEmpty(Material.LayerMapPath))
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Clear" 
                                      Color="Color.Error"
                                      OnClick="ClearLayerMap"/>
                    }
                </div>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                    8-bit grayscale PNG. White = material present, Black = absent.
                </MudText>
            </MudItem>
            
            <!-- Road Material Toggle -->
            <MudItem xs="12" sm="6">
                <MudSwitch @bind-Value="Material.IsRoadMaterial" 
                          Color="Color.Primary"
                          Label="Enable Road Smoothing"/>
            </MudItem>
            
            @if (Material.IsRoadMaterial)
            {
                <!-- Road Parameters -->
                <MudItem xs="12">
                    <MudDivider Class="my-2"/>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.EditRoad" Size="Size.Small" Class="mr-1"/>
                        Road Smoothing Parameters
                    </MudText>
                </MudItem>
                
                <!-- Preset Selection -->
                <MudItem xs="12">
                    <MudSelect T="RoadPresetType" 
                              Value="@Material.SelectedPreset"
                              ValueChanged="@OnPresetChanged"
                              Label="Road Preset"
                              Variant="Variant.Outlined"
                              AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="RoadPresetType.Custom">Custom</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.Highway">Highway (8m, professional quality)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.MountainRoad">Mountain Road (6m, hairpins)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.RacingCircuit">Racing Circuit (10m, tight turns)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.DirtRoad">Dirt Road (5m, rustic)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.TerrainFollowingSmooth">Terrain Following (Butterworth filter)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.MountainousUltraSmooth">Mountainous Ultra Smooth (aggressive leveling)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.HillyAggressive">Hilly Aggressive (moderate leveling)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.FlatModerate">Flat Moderate (light smoothing)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.FastTesting">Fast Testing (DirectMask)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.ExtremeNuclear">Extreme Nuclear (maximum smoothing)</MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                        Select a preset to apply optimized settings. You can customize individual parameters below.
                    </MudText>
                </MudItem>
                
                <!-- Primary Parameters (always visible) -->
                <MudItem xs="12" sm="6">
                    <div class="d-flex align-start gap-1">
                        <MudNumericField @bind-Value="Material.RoadWidthMeters" 
                                        Label="Road Width (meters)" 
                                        Variant="Variant.Outlined"
                                        Min="1.0f" Max="50.0f" Step="0.5f"
                                        HelperText="Width of the road surface"
                                        Class="flex-grow-1"/>
                        <HelpAdornment TooltipText="@RoadWidthMeters"/>
                    </div>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <div class="d-flex align-start gap-1">
                        <MudNumericField @bind-Value="Material.TerrainAffectedRangeMeters" 
                                        Label="Blend Range (meters)" 
                                        Variant="Variant.Outlined"
                                        Min="0.0f" Max="50.0f" Step="1.0f"
                                        HelperText="Shoulder/transition zone width"
                                        Class="flex-grow-1"/>
                        <HelpAdornment TooltipText="@TerrainAffectedRangeMeters"/>
                    </div>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <div class="d-flex align-start gap-1">
                        <MudNumericField @bind-Value="Material.RoadMaxSlopeDegrees" 
                                        Label="Max Road Slope (°)" 
                                        Variant="Variant.Outlined"
                                        Min="0.0f" Max="45.0f" Step="0.5f"
                                        HelperText="Maximum road gradient"
                                        Class="flex-grow-1"/>
                        <HelpAdornment TooltipText="@RoadMaxSlopeDegrees"/>
                    </div>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <div class="d-flex align-start gap-1">
                        <MudNumericField @bind-Value="Material.SideMaxSlopeDegrees" 
                                        Label="Max Side Slope (°)" 
                                        Variant="Variant.Outlined"
                                        Min="0.0f" Max="90.0f" Step="1.0f"
                                        HelperText="Maximum embankment slope"
                                        Class="flex-grow-1"/>
                        <HelpAdornment TooltipText="@SideMaxSlopeDegrees"/>
                    </div>
                </MudItem>
                
                <!-- Real-time Validation Warnings -->
                @if (GetValidationWarnings().Any())
                {
                    <MudItem xs="12">
                        @foreach (var warning in GetValidationWarnings())
                        {
                            <MudAlert Severity="@warning.Severity" 
                                     Dense="true" 
                                     Class="mb-2"
                                     Icon="@warning.Icon">
                                <div class="d-flex flex-column">
                                    <MudText Typo="Typo.body2"><strong>@warning.Title</strong></MudText>
                                    <MudText Typo="Typo.caption">@warning.Message</MudText>
                                    @if (!string.IsNullOrEmpty(warning.Recommendation))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                            <em>?? @warning.Recommendation</em>
                                        </MudText>
                                    }
                                </div>
                            </MudAlert>
                        }
                    </MudItem>
                }
                
                <!-- Advanced Settings (Nerd Mode) -->
                <MudItem xs="12">
                    <MudExpansionPanels Class="mt-2">
                        <MudExpansionPanel Text="Advanced Settings (Nerd Mode)" 
                                          IsInitiallyExpanded="false"
                                          Class="mud-elevation-1">
                            <TitleContent>
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" Color="Color.Secondary"/>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Advanced Settings (Nerd Mode)
                                    </MudText>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="mt-2">
                                    <!-- Algorithm Tab -->
                                    <MudTabPanel Text="Algorithm" Icon="@Icons.Material.Filled.Memory">
                                        <div class="pa-3">
                                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                                Choose the smoothing algorithm approach and core settings.
                                            </MudAlert>
                                            
                                            <MudPaper Class="pa-3" Elevation="1">
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudSelect T="RoadSmoothingApproach" 
                                                                      @bind-Value="Material.Approach"
                                                                      Label="Smoothing Approach"
                                                                      Variant="Variant.Outlined"
                                                                      HelperText="Spline = curved roads, DirectMask = intersections"
                                                                      Class="flex-grow-1">
                                                                <MudSelectItem Value="RoadSmoothingApproach.Spline">Spline (recommended)</MudSelectItem>
                                                                <MudSelectItem Value="RoadSmoothingApproach.DirectMask">DirectMask (robust)</MudSelectItem>
                                                            </MudSelect>
                                                            <HelpAdornment TooltipText="@Approach"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudSelect T="BlendFunctionType" 
                                                                      @bind-Value="Material.BlendFunctionType"
                                                                      Label="Blend Function"
                                                                      Variant="Variant.Outlined"
                                                                      HelperText="Terrain transition curve type"
                                                                      Class="flex-grow-1">
                                                                <MudSelectItem Value="BlendFunctionType.Linear">Linear</MudSelectItem>
                                                                <MudSelectItem Value="BlendFunctionType.Cosine">Cosine (smoothest)</MudSelectItem>
                                                                <MudSelectItem Value="BlendFunctionType.Cubic">Cubic</MudSelectItem>
                                                                <MudSelectItem Value="BlendFunctionType.Quintic">Quintic</MudSelectItem>
                                                            </MudSelect>
                                                            <HelpAdornment TooltipText="@BlendFunction"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.CrossSectionIntervalMeters" 
                                                                            Label="Cross-Section Interval (m)" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.1f" Max="5.0f" Step="0.1f"
                                                                            Format="F1"
                                                                            HelperText="Smaller = more detail, slower"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@CrossSectionIntervalMeters"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-center gap-1">
                                                            <MudSwitch T="bool" @bind-Value="Material.EnableTerrainBlending" 
                                                                      Color="Color.Primary"
                                                                      Label="Enable Terrain Blending"/>
                                                            <HelpAdornment TooltipText="@EnableTerrainBlending"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                        </div>
                                    </MudTabPanel>
                                    
                                    <!-- Spline Tab -->
                                    <MudTabPanel Text="Spline" Icon="@Icons.Material.Filled.Timeline" Disabled="@(Material.Approach != RoadSmoothingApproach.Spline)">
                                        <div class="pa-3">
                                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                                Spline extraction, curve fitting, and elevation smoothing parameters.
                                            </MudAlert>
                                            
                                            <!-- Curve Fitting Card -->
                                            <MudPaper Class="pa-3 mb-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.ShowChart" Size="Size.Small" Class="mr-1"/>
                                                    Curve Fitting
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                                    Controls how the spline curve follows the road centerline.
                                                </MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.SplineTension" 
                                                                            Label="Tension" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.0f" Max="1.0f" Step="0.1f"
                                                                            Format="F1"
                                                                            HelperText="0=loose curves, 1=tight"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SplineTension"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.SplineContinuity" 
                                                                            Label="Continuity" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="-1.0f" Max="1.0f" Step="0.1f"
                                                                            Format="F1"
                                                                            HelperText="-1=sharp corners, 1=smooth"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SplineContinuity"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.SplineBias" 
                                                                            Label="Bias" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="-1.0f" Max="1.0f" Step="0.1f"
                                                                            Format="F1"
                                                                            HelperText="Curve direction bias"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SplineBias"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                            
                                            <!-- Path Extraction Card -->
                                            <MudPaper Class="pa-3 mb-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Route" Size="Size.Small" Class="mr-1"/>
                                                    Path Extraction
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                                    Controls how road centerlines are extracted from the layer map.
                                                </MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.DensifyMaxSpacingPixels" 
                                                                            Label="Densify Spacing (px)" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.5f" Max="10.0f" Step="0.5f"
                                                                            Format="F1"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@DensifyMaxSpacingPixels"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.SimplifyTolerancePixels" 
                                                                            Label="Simplify Tolerance (px)" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.0f" Max="5.0f" Step="0.25f"
                                                                            Format="F2"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SimplifyTolerancePixels"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.BridgeEndpointMaxDistancePixels" 
                                                                            Label="Bridge Distance (px)" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.0f" Max="100.0f" Step="5.0f"
                                                                            Format="F0"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@BridgeEndpointMaxDistancePixels"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.MinPathLengthPixels" 
                                                                            Label="Min Path Length (px)" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="10.0f" Max="200.0f" Step="10.0f"
                                                                            Format="F0"
                                                                            HelperText="Shorter paths are filtered out"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@MinPathLengthPixels"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                                
                                                <!-- Graph Ordering sub-section -->
                                                <MudDivider Class="my-3"/>
                                                <div class="d-flex align-center gap-3 mb-2">
                                                    <div class="d-flex align-center gap-1">
                                                        <MudSwitch T="bool" @bind-Value="Material.UseGraphOrdering" 
                                                                  Color="Color.Primary"
                                                                  Label="Use Graph Ordering"/>
                                                        <HelpAdornment TooltipText="@UseGraphOrdering"/>
                                                    </div>
                                                    <div class="d-flex align-start gap-1">
                                                        <MudNumericField T="float" @bind-Value="Material.OrderingNeighborRadiusPixels" 
                                                                        Label="Neighbor Radius (px)" 
                                                                        Variant="Variant.Outlined"
                                                                        Min="1.0f" Max="10.0f" Step="0.5f"
                                                                        Format="F1"
                                                                        Disabled="@(!Material.UseGraphOrdering)"
                                                                        Style="max-width: 200px;"/>
                                                        <HelpAdornment TooltipText="@OrderingNeighborRadiusPixels"/>
                                                    </div>
                                                </div>
                                            </MudPaper>
                                            
                                            <!-- Junction Handling Card -->
                                            <MudPaper Class="pa-3 mb-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.CallSplit" Size="Size.Small" Class="mr-1"/>
                                                    Junction Handling
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                                    Controls behavior at road intersections.
                                                </MudText>
                                                <div class="d-flex align-center gap-3">
                                                    <div class="d-flex align-center gap-1">
                                                        <MudSwitch T="bool" @bind-Value="Material.PreferStraightThroughJunctions" 
                                                                  Color="Color.Primary"
                                                                  Label="Prefer Straight Through Junctions"/>
                                                        <HelpAdornment TooltipText="@PreferStraightThroughJunctions"/>
                                                    </div>
                                                    <div class="d-flex align-start gap-1">
                                                        <MudNumericField T="float" @bind-Value="Material.JunctionAngleThreshold" 
                                                                        Label="Angle Threshold (°)" 
                                                                        Variant="Variant.Outlined"
                                                                        Min="10.0f" Max="90.0f" Step="5.0f"
                                                                        Format="F0"
                                                                        Disabled="@(!Material.PreferStraightThroughJunctions)"
                                                                        HelperText="Max angle for 'straight through'"
                                                                        Style="max-width: 200px;"/>
                                                        <HelpAdornment TooltipText="@JunctionAngleThreshold"/>
                                                    </div>
                                                </div>
                                            </MudPaper>
                                            
                                            <!-- Elevation Smoothing Card -->
                                            <MudPaper Class="pa-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Terrain" Size="Size.Small" Class="mr-1"/>
                                                    Elevation Smoothing
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                                                    Controls how road elevation is smoothed along its length.
                                                </MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="int" @bind-Value="Material.SplineSmoothingWindowSize" 
                                                                            Label="Window Size" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="11" Max="501" Step="10"
                                                                            HelperText="Must be odd number"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SplineSmoothingWindowSize"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.GlobalLevelingStrength" 
                                                                            Label="Global Leveling Strength" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.0f" Max="1.0f" Step="0.05f"
                                                                            Format="F2"
                                                                            HelperText="0=follow terrain, 1=flat network"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@GlobalLevelingStrength"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                                
                                                <!-- Butterworth sub-section -->
                                                <MudDivider Class="my-3"/>
                                                <div class="d-flex align-center gap-3">
                                                    <div class="d-flex align-center gap-1">
                                                        <MudSwitch T="bool" @bind-Value="Material.SplineUseButterworthFilter" 
                                                                  Color="Color.Primary"
                                                                  Label="Butterworth Filter"/>
                                                        <HelpAdornment TooltipText="@SplineUseButterworthFilter"/>
                                                    </div>
                                                    <div class="d-flex align-start gap-1">
                                                        <MudNumericField T="int" @bind-Value="Material.SplineButterworthFilterOrder" 
                                                                        Label="Filter Order" 
                                                                        Variant="Variant.Outlined"
                                                                        Min="1" Max="8" Step="1"
                                                                        Disabled="@(!Material.SplineUseButterworthFilter)"
                                                                        HelperText="Higher = flatter"
                                                                        Style="max-width: 150px;"/>
                                                        <HelpAdornment TooltipText="@SplineButterworthFilterOrder"/>
                                                    </div>
                                                </div>
                                            </MudPaper>
                                        </div>
                                    </MudTabPanel>
                                    
                                    <!-- DirectMask Tab -->
                                    <MudTabPanel Text="DirectMask" Icon="@Icons.Material.Filled.GridOn" Disabled="@(Material.Approach != RoadSmoothingApproach.DirectMask)">
                                        <div class="pa-3">
                                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                                DirectMask approach parameters for grid-aligned sampling. Best for complex intersections.
                                            </MudAlert>
                                            
                                            <!-- Sampling Card -->
                                            <MudPaper Class="pa-3 mb-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.GridOn" Size="Size.Small" Class="mr-1"/>
                                                    Sampling
                                                </MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="int" @bind-Value="Material.DirectMaskSmoothingWindowSize" 
                                                                            Label="Smoothing Window Size" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="3" Max="100" Step="1"
                                                                            HelperText="Larger = smoother"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@DirectMaskSmoothingWindowSize"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="int" @bind-Value="Material.RoadPixelSearchRadius" 
                                                                            Label="Road Pixel Search Radius" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="1" Max="20" Step="1"
                                                                            HelperText="Search distance for road pixels"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@RoadPixelSearchRadius"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                            
                                            <!-- Filter Card -->
                                            <MudPaper Class="pa-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.FilterAlt" Size="Size.Small" Class="mr-1"/>
                                                    Butterworth Filter
                                                </MudText>
                                                <div class="d-flex align-center gap-3">
                                                    <div class="d-flex align-center gap-1">
                                                        <MudSwitch T="bool" @bind-Value="Material.DirectMaskUseButterworthFilter" 
                                                                  Color="Color.Primary"
                                                                  Label="Enable Butterworth Filter"/>
                                                        <HelpAdornment TooltipText="@DirectMaskUseButterworthFilter"/>
                                                    </div>
                                                    <div class="d-flex align-start gap-1">
                                                        <MudNumericField T="int" @bind-Value="Material.DirectMaskButterworthFilterOrder" 
                                                                        Label="Filter Order" 
                                                                        Variant="Variant.Outlined"
                                                                        Min="1" Max="8" Step="1"
                                                                        Disabled="@(!Material.DirectMaskUseButterworthFilter)"
                                                                        HelperText="Higher = flatter passband"
                                                                        Style="max-width: 150px;"/>
                                                        <HelpAdornment TooltipText="@DirectMaskButterworthFilterOrder"/>
                                                    </div>
                                                </div>
                                            </MudPaper>
                                        </div>
                                    </MudTabPanel>
                                    
                                    <!-- Post-Processing Tab -->
                                    <MudTabPanel Text="Post-Processing" Icon="@Icons.Material.Filled.AutoFixHigh">
                                        <div class="pa-3">
                                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                                Post-processing smoothing to eliminate staircase artifacts on the road surface.
                                            </MudAlert>
                                            
                                            <MudPaper Class="pa-3" Elevation="1">
                                                <div class="d-flex align-center gap-3 mb-3">
                                                    <div class="d-flex align-center gap-1">
                                                        <MudSwitch T="bool" @bind-Value="Material.EnablePostProcessingSmoothing" 
                                                                  Color="Color.Primary"
                                                                  Label="Enable Post-Processing Smoothing"/>
                                                        <HelpAdornment TooltipText="@EnablePostProcessingSmoothing"/>
                                                    </div>
                                                </div>
                                                
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudSelect T="PostProcessingSmoothingType" 
                                                                      @bind-Value="Material.SmoothingType"
                                                                      Label="Smoothing Type"
                                                                      Variant="Variant.Outlined"
                                                                      Disabled="@(!Material.EnablePostProcessingSmoothing)"
                                                                      Class="flex-grow-1">
                                                                <MudSelectItem Value="PostProcessingSmoothingType.Gaussian">Gaussian (best quality)</MudSelectItem>
                                                                <MudSelectItem Value="PostProcessingSmoothingType.Box">Box (fast)</MudSelectItem>
                                                                <MudSelectItem Value="PostProcessingSmoothingType.Bilateral">Bilateral (edge-preserving)</MudSelectItem>
                                                            </MudSelect>
                                                            <HelpAdornment TooltipText="@SmoothingType"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.SmoothingMaskExtensionMeters" 
                                                                            Label="Mask Extension (m)" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.0f" Max="20.0f" Step="1.0f"
                                                                            Format="F1"
                                                                            Disabled="@(!Material.EnablePostProcessingSmoothing)"
                                                                            HelperText="Smooth beyond road edge"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SmoothingMaskExtensionMeters"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="int" @bind-Value="Material.SmoothingKernelSize" 
                                                                            Label="Kernel Size" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="3" Max="21" Step="2"
                                                                            Disabled="@(!Material.EnablePostProcessingSmoothing)"
                                                                            HelperText="Must be odd"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SmoothingKernelSize"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="float" @bind-Value="Material.SmoothingSigma" 
                                                                            Label="Sigma" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="0.1f" Max="5.0f" Step="0.1f"
                                                                            Format="F1"
                                                                            Disabled="@(!Material.EnablePostProcessingSmoothing)"
                                                                            HelperText="Blur strength"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SmoothingSigma"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <div class="d-flex align-start gap-1">
                                                            <MudNumericField T="int" @bind-Value="Material.SmoothingIterations" 
                                                                            Label="Iterations" 
                                                                            Variant="Variant.Outlined"
                                                                            Min="1" Max="5" Step="1"
                                                                            Disabled="@(!Material.EnablePostProcessingSmoothing)"
                                                                            HelperText="More = smoother"
                                                                            Class="flex-grow-1"/>
                                                            <HelpAdornment TooltipText="@SmoothingIterations"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                        </div>
                                    </MudTabPanel>
                                    
                                    <!-- Debug Tab -->
                                    <MudTabPanel Text="Debug" Icon="@Icons.Material.Filled.BugReport">
                                        <div class="pa-3">
                                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-3">
                                                Debug output options. These create additional image files for troubleshooting.
                                            </MudAlert>
                                            
                                            <MudPaper Class="pa-3" Elevation="1">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" Class="mr-1"/>
                                                    Export Debug Images
                                                </MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-center gap-1">
                                                            <MudSwitch T="bool" @bind-Value="Material.ExportSmoothedHeightmapWithOutlines" 
                                                                      Color="Color.Secondary"
                                                                      Label="Heightmap with Road Outlines"/>
                                                            <HelpAdornment TooltipText="@ExportSmoothedHeightmapWithOutlines"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-center gap-1">
                                                            <MudSwitch T="bool" @bind-Value="Material.ExportSplineDebugImage" 
                                                                      Color="Color.Secondary"
                                                                      Label="Spline Visualization"
                                                                      Disabled="@(Material.Approach != RoadSmoothingApproach.Spline)"/>
                                                            <HelpAdornment TooltipText="@ExportSplineDebugImage"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-center gap-1">
                                                            <MudSwitch T="bool" @bind-Value="Material.ExportSkeletonDebugImage" 
                                                                      Color="Color.Secondary"
                                                                      Label="Skeleton Extraction"
                                                                      Disabled="@(Material.Approach != RoadSmoothingApproach.Spline)"/>
                                                            <HelpAdornment TooltipText="@ExportSkeletonDebugImage"/>
                                                        </div>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <div class="d-flex align-center gap-1">
                                                            <MudSwitch T="bool" @bind-Value="Material.ExportSmoothedElevationDebugImage" 
                                                                      Color="Color.Secondary"
                                                                      Label="Elevation Profile"
                                                                      Disabled="@(Material.Approach != RoadSmoothingApproach.Spline)"/>
                                                            <HelpAdornment TooltipText="@ExportSmoothedElevationDebugImage"/>
                                                        </div>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                        </div>
                                    </MudTabPanel>
                                </MudTabs>
                            </ChildContent>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudItem>
            }
        </MudGrid>
    </ChildContent>
</MudExpansionPanel>

@code {
[Parameter] public TerrainMaterialItemExtended Material { get; set; } = null!;
[Parameter] public EventCallback<TerrainMaterialItemExtended> OnMaterialChanged { get; set; }

/// <summary>
/// Represents a validation warning with severity and recommendation
/// </summary>
private record ValidationWarning(
    Severity Severity, 
    string Title, 
    string Message, 
    string? Recommendation = null,
    string Icon = Icons.Material.Filled.Warning);

    /// <summary>
    /// Gets all current validation warnings based on parameter combinations
    /// </summary>
    private List<ValidationWarning> GetValidationWarnings()
    {
        var warnings = new List<ValidationWarning>();
        
        if (!Material.IsRoadMaterial)
            return warnings;

        // ========================================
        // CRITICAL: GlobalLevelingStrength + TerrainAffectedRangeMeters
        // ========================================
        if (Material.GlobalLevelingStrength > 0.5f && Material.TerrainAffectedRangeMeters < 15.0f)
        {
            warnings.Add(new ValidationWarning(
                Severity.Error,
                "Disconnected Road Risk",
                $"GlobalLevelingStrength ({Material.GlobalLevelingStrength:F2}) > 0.5 with TerrainAffectedRangeMeters ({Material.TerrainAffectedRangeMeters:F1}m) < 15m will likely create disconnected 'dotted' road segments.",
                $"Either reduce GlobalLevelingStrength to ? 0.5 OR increase TerrainAffectedRangeMeters to ? 15m (recommended: 20m+)",
                Icons.Material.Filled.LinkOff));
        }
        else if (Material.GlobalLevelingStrength > 0.3f && Material.TerrainAffectedRangeMeters < 12.0f)
        {
            warnings.Add(new ValidationWarning(
                Severity.Warning,
                "Blend Zone May Be Too Narrow",
                $"GlobalLevelingStrength ({Material.GlobalLevelingStrength:F2}) with TerrainAffectedRangeMeters ({Material.TerrainAffectedRangeMeters:F1}m) may cause visible transitions.",
                $"Consider increasing TerrainAffectedRangeMeters to ? 12m for smoother blending",
                Icons.Material.Filled.Warning));
        }

        // ========================================
        // CrossSectionIntervalMeters vs Road Impact Radius
        // ========================================
        float totalImpactRadius = (Material.RoadWidthMeters / 2.0f) + Material.TerrainAffectedRangeMeters;
        float recommendedMaxInterval = totalImpactRadius / 3.0f;
        
        if (Material.CrossSectionIntervalMeters > recommendedMaxInterval)
        {
            warnings.Add(new ValidationWarning(
                Severity.Warning,
                "Cross-Section Spacing May Cause Gaps",
                $"CrossSectionIntervalMeters ({Material.CrossSectionIntervalMeters:F2}m) is large relative to the road impact radius ({totalImpactRadius:F1}m).",
                $"Reduce CrossSectionIntervalMeters to ? {recommendedMaxInterval:F2}m for continuous coverage",
                Icons.Material.Filled.SpaceBar));
        }

        // ========================================
        // SmoothingWindowSize (odd number check for Spline)
        // ========================================
        if (Material.Approach == RoadSmoothingApproach.Spline && Material.SplineSmoothingWindowSize % 2 == 0)
        {
            warnings.Add(new ValidationWarning(
                Severity.Info,
                "Window Size Should Be Odd",
                $"SmoothingWindowSize ({Material.SplineSmoothingWindowSize}) should be an odd number for symmetric smoothing.",
                $"Change to {Material.SplineSmoothingWindowSize + 1} for optimal results",
                Icons.Material.Filled.Info));
        }

        // ========================================
        // SmoothingKernelSize (odd number check for Post-Processing)
        // ========================================
        if (Material.EnablePostProcessingSmoothing && Material.SmoothingKernelSize % 2 == 0)
        {
            warnings.Add(new ValidationWarning(
                Severity.Warning,
                "Kernel Size Must Be Odd",
                $"SmoothingKernelSize ({Material.SmoothingKernelSize}) must be an odd number.",
                $"Change to {Material.SmoothingKernelSize + 1}",
                Icons.Material.Filled.GridOn));
        }

        // ========================================
        // SmoothingMaskExtensionMeters vs CrossSectionIntervalMeters
        // ========================================
        if (Material.EnablePostProcessingSmoothing && 
            Material.SmoothingMaskExtensionMeters < Material.CrossSectionIntervalMeters * 2)
        {
            warnings.Add(new ValidationWarning(
                Severity.Info,
                "Mask Extension May Be Insufficient",
                $"SmoothingMaskExtensionMeters ({Material.SmoothingMaskExtensionMeters:F1}m) should be ? 2× CrossSectionIntervalMeters ({Material.CrossSectionIntervalMeters:F2}m) to fully eliminate staircase artifacts.",
                $"Increase to ? {Material.CrossSectionIntervalMeters * 2:F1}m",
                Icons.Material.Filled.Expand));
        }

        // ========================================
        // Butterworth not enabled for hilly terrain (high window size suggests hilly)
        // ========================================
        if (Material.Approach == RoadSmoothingApproach.Spline && 
            !Material.SplineUseButterworthFilter && 
            Material.SplineSmoothingWindowSize > 150)
        {
            warnings.Add(new ValidationWarning(
                Severity.Info,
                "Consider Butterworth Filter",
                $"Large smoothing window ({Material.SplineSmoothingWindowSize}) suggests hilly terrain. Butterworth filter provides better results than box filter for elevation changes.",
                "Enable Butterworth Filter for 'maximally flat' passband without ringing artifacts",
                Icons.Material.Filled.FilterAlt));
        }

        // ========================================
        // High Butterworth order warning
        // ========================================
        int butterworthOrder = Material.Approach == RoadSmoothingApproach.Spline 
            ? Material.SplineButterworthFilterOrder 
            : Material.DirectMaskButterworthFilterOrder;
        bool butterworthEnabled = Material.Approach == RoadSmoothingApproach.Spline 
            ? Material.SplineUseButterworthFilter 
            : Material.DirectMaskUseButterworthFilter;
            
        if (butterworthEnabled && butterworthOrder > 6)
        {
            warnings.Add(new ValidationWarning(
                Severity.Info,
                "High Butterworth Order",
                $"Filter order {butterworthOrder} is very aggressive. While it provides maximum flatness, it may introduce subtle ringing at sharp transitions.",
                "Order 3-4 is usually optimal for most terrain types",
                Icons.Material.Filled.TrendingFlat));
        }

        // ========================================
        // Very small road width
        // ========================================
        if (Material.RoadWidthMeters < 3.0f)
        {
            warnings.Add(new ValidationWarning(
                Severity.Info,
                "Narrow Road",
                $"Road width ({Material.RoadWidthMeters:F1}m) is very narrow. Standard single-lane roads are typically 3-4m, two-lane roads 6-8m.",
                "Ensure this is intentional (e.g., footpath, trail)",
                Icons.Material.Filled.Straighten));
        }

        // ========================================
        // Steep road slope
        // ========================================
        if (Material.RoadMaxSlopeDegrees > 12.0f)
        {
            warnings.Add(new ValidationWarning(
                Severity.Info,
                "Steep Road Grade",
                $"Max road slope ({Material.RoadMaxSlopeDegrees:F1}°) exceeds typical limits. Standard highways: 4-6°, mountain roads: 8-10°.",
                "Very steep grades (>12°) may feel unrealistic for paved roads",
                Icons.Material.Filled.Landscape));
        }

        return warnings;
    }

    /// <summary>
    /// Gets count of validation errors for title badge
    /// </summary>
    private int GetValidationErrorCount()
    {
        return GetValidationWarnings().Count(w => w.Severity == Severity.Error);
    }

    /// <summary>
    /// Gets count of validation warnings for title badge
    /// </summary>
    private int GetValidationWarningCount()
    {
        return GetValidationWarnings().Count(w => w.Severity == Severity.Warning);
    }

    private string GetPanelTitle()
    {
        return $"[{Material.Order}] {Material.InternalName}";
    }

    private async Task SelectLayerMap()
    {
        string? selectedPath = null;
        var staThread = new Thread(() =>
        {
            using var dialog = new OpenFileDialog();
            dialog.Filter = "PNG Images (*.png)|*.png|All Files (*.*)|*.*";
            dialog.Title = $"Select Layer Map for {Material.InternalName}";
            if (dialog.ShowDialog() == DialogResult.OK)
            {
                selectedPath = dialog.FileName;
            }
        });
        staThread.SetApartmentState(ApartmentState.STA);
        staThread.Start();
        staThread.Join();

        if (!string.IsNullOrEmpty(selectedPath))
        {
            Material.LayerMapPath = selectedPath;
            await OnMaterialChanged.InvokeAsync(Material);
        }
    }

    private async Task ClearLayerMap()
    {
        Material.LayerMapPath = null;
        await OnMaterialChanged.InvokeAsync(Material);
    }

    private async Task OnPresetChanged(RoadPresetType preset)
    {
        Material.SelectedPreset = preset;
        
        // Apply ALL preset values
        var presetParams = GetPresetParameters(preset);
        if (presetParams != null)
        {
            Material.ApplyPreset(presetParams);
        }
        
        await OnMaterialChanged.InvokeAsync(Material);
    }

    /// <summary>
    /// Gets the RoadSmoothingParameters for a given preset type.
    /// Returns null for Custom preset.
    /// </summary>
    public static RoadSmoothingParameters? GetPresetParameters(RoadPresetType preset)
    {
        return preset switch
        {
            RoadPresetType.Highway => RoadSmoothingPresets.Highway,
            RoadPresetType.MountainRoad => RoadSmoothingPresets.MountainRoad,
            RoadPresetType.RacingCircuit => RoadSmoothingPresets.RacingCircuit,
            RoadPresetType.DirtRoad => RoadSmoothingPresets.DirtRoad,
            RoadPresetType.TerrainFollowingSmooth => RoadSmoothingPresets.TerrainFollowingSmooth,
            RoadPresetType.MountainousUltraSmooth => RoadSmoothingPresets.MountainousUltraSmooth,
            RoadPresetType.HillyAggressive => RoadSmoothingPresets.HillyAggressive,
            RoadPresetType.FlatModerate => RoadSmoothingPresets.FlatModerate,
            RoadPresetType.FastTesting => RoadSmoothingPresets.FastTesting,
            RoadPresetType.ExtremeNuclear => RoadSmoothingPresets.ExtremeNuclear,
            _ => null
        };
    }

    /// <summary>
    /// Available road smoothing presets from RoadSmoothingPresets class
    /// </summary>
    public enum RoadPresetType
    {
        Custom,
        Highway,
        MountainRoad,
        RacingCircuit,
        DirtRoad,
        TerrainFollowingSmooth,
        MountainousUltraSmooth,
        HillyAggressive,
        FlatModerate,
        FastTesting,
        ExtremeNuclear
    }
    
    /// <summary>
    /// Extended terrain material item with ALL road smoothing properties for terrain generation
    /// </summary>
    public class TerrainMaterialItemExtended
    {
        public int Order { get; set; }
        public string MaterialName { get; set; } = string.Empty;
        public string InternalName { get; set; } = string.Empty;
        public string JsonKey { get; set; } = string.Empty;
        public string Selector { get; set; } = "materials";
        
        // Layer map
        public string? LayerMapPath { get; set; }
        public bool HasLayerMap => !string.IsNullOrEmpty(LayerMapPath);
        
        // Road smoothing enabled
        public bool IsRoadMaterial { get; set; }
        public RoadPresetType SelectedPreset { get; set; } = RoadPresetType.Highway;
        
        // ========================================
        // PRIMARY PARAMETERS (always visible)
        // ========================================
        public float RoadWidthMeters { get; set; } = 8.0f;
        public float TerrainAffectedRangeMeters { get; set; } = 6.0f;
        public float RoadMaxSlopeDegrees { get; set; } = 6.0f;
        public float SideMaxSlopeDegrees { get; set; } = 45.0f;
        
        // ========================================
        // ALGORITHM SETTINGS
        // ========================================
        public RoadSmoothingApproach Approach { get; set; } = RoadSmoothingApproach.Spline;
        public BlendFunctionType BlendFunctionType { get; set; } = BlendFunctionType.Cosine;
        public float CrossSectionIntervalMeters { get; set; } = 0.5f;
        public bool EnableTerrainBlending { get; set; } = true;
        
        // ========================================
        // SPLINE PARAMETERS
        // ========================================
        // Curve fitting
        public float SplineTension { get; set; } = 0.2f;
        public float SplineContinuity { get; set; } = 0.7f;
        public float SplineBias { get; set; } = 0.0f;
        
        // Path extraction
        public bool UseGraphOrdering { get; set; } = true;
        public bool PreferStraightThroughJunctions { get; set; } = false;
        public float DensifyMaxSpacingPixels { get; set; } = 1.5f;
        public float SimplifyTolerancePixels { get; set; } = 0.5f;
        public float BridgeEndpointMaxDistancePixels { get; set; } = 40.0f;
        public float MinPathLengthPixels { get; set; } = 100.0f;
        public float JunctionAngleThreshold { get; set; } = 90.0f;
        public float OrderingNeighborRadiusPixels { get; set; } = 2.5f;
        
        // Elevation smoothing (Spline)
        public int SplineSmoothingWindowSize { get; set; } = 301;
        public bool SplineUseButterworthFilter { get; set; } = true;
        public int SplineButterworthFilterOrder { get; set; } = 4;
        public float GlobalLevelingStrength { get; set; } = 0.0f;
        
        // ========================================
        // DIRECTMASK PARAMETERS
        // ========================================
        public int DirectMaskSmoothingWindowSize { get; set; } = 10;
        public int RoadPixelSearchRadius { get; set; } = 3;
        public bool DirectMaskUseButterworthFilter { get; set; } = true;
        public int DirectMaskButterworthFilterOrder { get; set; } = 3;
        
        // ========================================
        // POST-PROCESSING SMOOTHING
        // ========================================
        public bool EnablePostProcessingSmoothing { get; set; } = true;
        public PostProcessingSmoothingType SmoothingType { get; set; } = PostProcessingSmoothingType.Gaussian;
        public int SmoothingKernelSize { get; set; } = 7;
        public float SmoothingSigma { get; set; } = 1.5f;
        public int SmoothingIterations { get; set; } = 1;
        public float SmoothingMaskExtensionMeters { get; set; } = 6.0f;
        
        // ========================================
        // DEBUG OUTPUT
        // ========================================
        public bool ExportSmoothedHeightmapWithOutlines { get; set; } = false;
        public bool ExportSplineDebugImage { get; set; } = false;
        public bool ExportSkeletonDebugImage { get; set; } = false;
        public bool ExportSmoothedElevationDebugImage { get; set; } = false;
        
        /// <summary>
        /// Applies all values from a preset to this material's settings.
        /// </summary>
        public void ApplyPreset(RoadSmoothingParameters preset)
        {
            // Primary parameters
            RoadWidthMeters = preset.RoadWidthMeters;
            TerrainAffectedRangeMeters = preset.TerrainAffectedRangeMeters;
            RoadMaxSlopeDegrees = preset.RoadMaxSlopeDegrees;
            SideMaxSlopeDegrees = preset.SideMaxSlopeDegrees;
            
            // Algorithm settings
            Approach = preset.Approach;
            BlendFunctionType = preset.BlendFunctionType;
            CrossSectionIntervalMeters = preset.CrossSectionIntervalMeters;
            EnableTerrainBlending = preset.EnableTerrainBlending;
            
            // Post-processing
            EnablePostProcessingSmoothing = preset.EnablePostProcessingSmoothing;
            SmoothingType = preset.SmoothingType;
            SmoothingKernelSize = preset.SmoothingKernelSize;
            SmoothingSigma = preset.SmoothingSigma;
            SmoothingIterations = preset.SmoothingIterations;
            SmoothingMaskExtensionMeters = preset.SmoothingMaskExtensionMeters;
            
            // Debug
            ExportSmoothedHeightmapWithOutlines = preset.ExportSmoothedHeightmapWithOutlines;
            
            // Spline parameters
            if (preset.SplineParameters != null)
            {
                SplineTension = preset.SplineParameters.SplineTension;
                SplineContinuity = preset.SplineParameters.SplineContinuity;
                SplineBias = preset.SplineParameters.SplineBias;
                UseGraphOrdering = preset.SplineParameters.UseGraphOrdering;
                PreferStraightThroughJunctions = preset.SplineParameters.PreferStraightThroughJunctions;
                DensifyMaxSpacingPixels = preset.SplineParameters.DensifyMaxSpacingPixels;
                SimplifyTolerancePixels = preset.SplineParameters.SimplifyTolerancePixels;
                BridgeEndpointMaxDistancePixels = preset.SplineParameters.BridgeEndpointMaxDistancePixels;
                MinPathLengthPixels = preset.SplineParameters.MinPathLengthPixels;
                JunctionAngleThreshold = preset.SplineParameters.JunctionAngleThreshold;
                OrderingNeighborRadiusPixels = preset.SplineParameters.OrderingNeighborRadiusPixels;
                SplineSmoothingWindowSize = preset.SplineParameters.SmoothingWindowSize;
                SplineUseButterworthFilter = preset.SplineParameters.UseButterworthFilter;
                SplineButterworthFilterOrder = preset.SplineParameters.ButterworthFilterOrder;
                GlobalLevelingStrength = preset.SplineParameters.GlobalLevelingStrength;
                ExportSplineDebugImage = preset.SplineParameters.ExportSplineDebugImage;
                ExportSkeletonDebugImage = preset.SplineParameters.ExportSkeletonDebugImage;
                ExportSmoothedElevationDebugImage = preset.SplineParameters.ExportSmoothedElevationDebugImage;
            }
            
            // DirectMask parameters
            if (preset.DirectMaskParameters != null)
            {
                DirectMaskSmoothingWindowSize = preset.DirectMaskParameters.SmoothingWindowSize;
                RoadPixelSearchRadius = preset.DirectMaskParameters.RoadPixelSearchRadius;
                DirectMaskUseButterworthFilter = preset.DirectMaskParameters.UseButterworthFilter;
                DirectMaskButterworthFilterOrder = preset.DirectMaskParameters.ButterworthFilterOrder;
            }
        }
        
        /// <summary>
        /// Builds the full RoadSmoothingParameters from all stored values.
        /// </summary>
        public RoadSmoothingParameters BuildRoadSmoothingParameters(string? debugOutputDirectory = null)
        {
            var result = new RoadSmoothingParameters
            {
                // Primary parameters
                RoadWidthMeters = RoadWidthMeters,
                TerrainAffectedRangeMeters = TerrainAffectedRangeMeters,
                RoadMaxSlopeDegrees = RoadMaxSlopeDegrees,
                SideMaxSlopeDegrees = SideMaxSlopeDegrees,
                
                // Algorithm settings
                Approach = Approach,
                BlendFunctionType = BlendFunctionType,
                CrossSectionIntervalMeters = CrossSectionIntervalMeters,
                EnableTerrainBlending = EnableTerrainBlending,
                
                // Post-processing
                EnablePostProcessingSmoothing = EnablePostProcessingSmoothing,
                SmoothingType = SmoothingType,
                SmoothingKernelSize = SmoothingKernelSize,
                SmoothingSigma = SmoothingSigma,
                SmoothingIterations = SmoothingIterations,
                SmoothingMaskExtensionMeters = SmoothingMaskExtensionMeters,
                
                // Debug
                DebugOutputDirectory = debugOutputDirectory,
                ExportSmoothedHeightmapWithOutlines = ExportSmoothedHeightmapWithOutlines
            };
            
            // Spline parameters
            result.SplineParameters = new SplineRoadParameters
            {
                SplineTension = SplineTension,
                SplineContinuity = SplineContinuity,
                SplineBias = SplineBias,
                UseGraphOrdering = UseGraphOrdering,
                PreferStraightThroughJunctions = PreferStraightThroughJunctions,
                DensifyMaxSpacingPixels = DensifyMaxSpacingPixels,
                SimplifyTolerancePixels = SimplifyTolerancePixels,
                BridgeEndpointMaxDistancePixels = BridgeEndpointMaxDistancePixels,
                MinPathLengthPixels = MinPathLengthPixels,
                JunctionAngleThreshold = JunctionAngleThreshold,
                OrderingNeighborRadiusPixels = OrderingNeighborRadiusPixels,
                SmoothingWindowSize = SplineSmoothingWindowSize,
                UseButterworthFilter = SplineUseButterworthFilter,
                ButterworthFilterOrder = SplineButterworthFilterOrder,
                GlobalLevelingStrength = GlobalLevelingStrength,
                ExportSplineDebugImage = ExportSplineDebugImage,
                ExportSkeletonDebugImage = ExportSkeletonDebugImage,
                ExportSmoothedElevationDebugImage = ExportSmoothedElevationDebugImage
            };
            
            // DirectMask parameters
            result.DirectMaskParameters = new DirectMaskRoadParameters
            {
                SmoothingWindowSize = DirectMaskSmoothingWindowSize,
                RoadPixelSearchRadius = RoadPixelSearchRadius,
                UseButterworthFilter = DirectMaskUseButterworthFilter,
                ButterworthFilterOrder = DirectMaskButterworthFilterOrder
            };
            
            return result;
        }
    }
}
