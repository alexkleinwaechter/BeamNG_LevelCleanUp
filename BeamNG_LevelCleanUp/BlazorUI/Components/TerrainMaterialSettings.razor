@using DialogResult = System.Windows.Forms.DialogResult
@using BeamNgTerrainPoc.Terrain.Models
@using BeamNgTerrainPoc.Examples

<MudExpansionPanel Text="@GetPanelTitle()" 
                   IsInitiallyExpanded="false"
                   Class="mb-2">
    <TitleContent>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small"/>
            <MudText Typo="Typo.body1">
                <strong>[@Material.Order]</strong> @Material.InternalName
            </MudText>
            @if (Material.HasLayerMap)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                    Layer Map
                </MudChip>
            }
            @if (Material.IsRoadMaterial)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                    Road
                </MudChip>
            }
        </div>
    </TitleContent>
    <ChildContent>
        <MudGrid Spacing="2" Class="pa-2">
            <!-- Layer Map Selection -->
            <MudItem xs="12">
                <MudText Typo="Typo.subtitle2" Class="mb-2">Layer Map (Optional)</MudText>
                <div class="d-flex align-center gap-2">
                    <MudTextField @bind-Value="Material.LayerMapPath" 
                                 Label="Layer Map Path" 
                                 Variant="Variant.Outlined"
                                 ReadOnly="true"
                                 Placeholder="No layer map selected"
                                 Class="flex-grow-1"/>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Image"
                              OnClick="SelectLayerMap">
                        Browse
                    </MudButton>
                    @if (!string.IsNullOrEmpty(Material.LayerMapPath))
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Clear" 
                                      Color="Color.Error"
                                      OnClick="ClearLayerMap"/>
                    }
                </div>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                    8-bit grayscale PNG. White = material present, Black = absent.
                </MudText>
            </MudItem>
            
            <!-- Road Material Toggle -->
            <MudItem xs="12" sm="6">
                <MudSwitch @bind-Value="Material.IsRoadMaterial" 
                          Color="Color.Primary"
                          Label="Enable Road Smoothing"/>
            </MudItem>
            
            @if (Material.IsRoadMaterial)
            {
                <!-- Road Parameters -->
                <MudItem xs="12">
                    <MudDivider Class="my-2"/>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.EditRoad" Size="Size.Small" Class="mr-1"/>
                        Road Smoothing Parameters
                    </MudText>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="Material.RoadWidthMeters" 
                                    Label="Road Width (meters)" 
                                    Variant="Variant.Outlined"
                                    Min="1.0f" Max="50.0f" Step="0.5f"
                                    HelperText="Width of the road surface"/>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="Material.TerrainAffectedRangeMeters" 
                                    Label="Blend Range (meters)" 
                                    Variant="Variant.Outlined"
                                    Min="0.0f" Max="50.0f" Step="1.0f"
                                    HelperText="Shoulder/transition zone width"/>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="Material.RoadMaxSlopeDegrees" 
                                    Label="Max Road Slope (°)" 
                                    Variant="Variant.Outlined"
                                    Min="0.0f" Max="45.0f" Step="0.5f"
                                    HelperText="Maximum road gradient"/>
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="Material.SideMaxSlopeDegrees" 
                                    Label="Max Side Slope (°)" 
                                    Variant="Variant.Outlined"
                                    Min="0.0f" Max="90.0f" Step="1.0f"
                                    HelperText="Maximum embankment slope"/>
                </MudItem>
                
                <MudItem xs="12">
                    <MudSelect T="RoadPresetType" 
                              Value="@Material.SelectedPreset"
                              ValueChanged="@OnPresetChanged"
                              Label="Road Preset"
                              Variant="Variant.Outlined"
                              AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="RoadPresetType.Custom">Custom</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.Highway">Highway (8m, professional quality)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.MountainRoad">Mountain Road (6m, steep grades)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.DirtRoad">Dirt Road (5m, rustic)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.TerrainFollowingSmooth">Terrain Following (Butterworth filter)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.MountainousUltraSmooth">Mountainous Ultra Smooth (aggressive leveling)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.HillyAggressive">Hilly Aggressive (moderate leveling)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.FlatModerate">Flat Moderate (light smoothing)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.FastTesting">Fast Testing (DirectMask)</MudSelectItem>
                        <MudSelectItem Value="RoadPresetType.ExtremeNuclear">Extreme Nuclear (maximum smoothing)</MudSelectItem>
                    </MudSelect>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                        Select a preset to use optimized settings. The 4 parameters above will override preset values.
                    </MudText>
                </MudItem>
            }
        </MudGrid>
    </ChildContent>
</MudExpansionPanel>

@code {
[Parameter] public TerrainMaterialItemExtended Material { get; set; } = null!;
[Parameter] public EventCallback<TerrainMaterialItemExtended> OnMaterialChanged { get; set; }

private string GetPanelTitle()
{
    return $"[{Material.Order}] {Material.InternalName}";
}

private async Task SelectLayerMap()
{
    string? selectedPath = null;
    var staThread = new Thread(() =>
    {
        using var dialog = new OpenFileDialog();
        dialog.Filter = "PNG Images (*.png)|*.png|All Files (*.*)|*.*";
        dialog.Title = $"Select Layer Map for {Material.InternalName}";
        if (dialog.ShowDialog() == DialogResult.OK)
        {
            selectedPath = dialog.FileName;
        }
    });
    staThread.SetApartmentState(ApartmentState.STA);
    staThread.Start();
    staThread.Join();

    if (!string.IsNullOrEmpty(selectedPath))
    {
        Material.LayerMapPath = selectedPath;
        await OnMaterialChanged.InvokeAsync(Material);
    }
}

private async Task ClearLayerMap()
{
    Material.LayerMapPath = null;
    await OnMaterialChanged.InvokeAsync(Material);
}

private async Task OnPresetChanged(RoadPresetType preset)
{
    Material.SelectedPreset = preset;
        
    // Apply preset values to the 4 prominent parameters
    var presetParams = GetPresetParameters(preset);
    if (presetParams != null)
    {
        Material.RoadWidthMeters = presetParams.RoadWidthMeters;
        Material.TerrainAffectedRangeMeters = presetParams.TerrainAffectedRangeMeters;
        Material.RoadMaxSlopeDegrees = presetParams.RoadMaxSlopeDegrees;
        Material.SideMaxSlopeDegrees = presetParams.SideMaxSlopeDegrees;
    }
        
    await OnMaterialChanged.InvokeAsync(Material);
}

/// <summary>
/// Gets the RoadSmoothingParameters for a given preset type.
/// Returns null for Custom preset.
/// </summary>
public static RoadSmoothingParameters? GetPresetParameters(RoadPresetType preset)
{
    return preset switch
    {
        RoadPresetType.Highway => RoadSmoothingPresets.Highway,
        RoadPresetType.MountainRoad => RoadSmoothingPresets.MountainRoad,
        RoadPresetType.DirtRoad => RoadSmoothingPresets.DirtRoad,
        RoadPresetType.TerrainFollowingSmooth => RoadSmoothingPresets.TerrainFollowingSmooth,
        RoadPresetType.MountainousUltraSmooth => RoadSmoothingPresets.MountainousUltraSmooth,
        RoadPresetType.HillyAggressive => RoadSmoothingPresets.HillyAggressive,
        RoadPresetType.FlatModerate => RoadSmoothingPresets.FlatModerate,
        RoadPresetType.FastTesting => RoadSmoothingPresets.FastTesting,
        RoadPresetType.ExtremeNuclear => RoadSmoothingPresets.ExtremeNuclear,
        _ => null
    };
}

/// <summary>
/// Available road smoothing presets from RoadSmoothingPresets class
/// </summary>
public enum RoadPresetType
{
    Custom,
    Highway,
    MountainRoad,
    DirtRoad,
    TerrainFollowingSmooth,
    MountainousUltraSmooth,
    HillyAggressive,
    FlatModerate,
    FastTesting,
    ExtremeNuclear
}
    
    /// <summary>
    /// Extended terrain material item with additional properties for terrain generation
    /// </summary>
    public class TerrainMaterialItemExtended
    {
        public int Order { get; set; }
        public string MaterialName { get; set; } = string.Empty;
        public string InternalName { get; set; } = string.Empty;
        public string JsonKey { get; set; } = string.Empty;
        public string Selector { get; set; } = "materials";
        
        // Layer map
        public string? LayerMapPath { get; set; }
        public bool HasLayerMap => !string.IsNullOrEmpty(LayerMapPath);
        
        // Road smoothing
        public bool IsRoadMaterial { get; set; }
        public RoadPresetType SelectedPreset { get; set; } = RoadPresetType.Highway;
        
        // Prominent parameters (override preset values)
        public float RoadWidthMeters { get; set; } = 8.0f;
        public float TerrainAffectedRangeMeters { get; set; } = 6.0f;
        public float RoadMaxSlopeDegrees { get; set; } = 6.0f;
        public float SideMaxSlopeDegrees { get; set; } = 45.0f;
        
        /// <summary>
        /// Builds the full RoadSmoothingParameters by starting with the selected preset
        /// and overriding the 4 prominent parameters.
        /// </summary>
        public RoadSmoothingParameters BuildRoadSmoothingParameters(string? debugOutputDirectory = null)
        {
            // Start with preset or create default
            var baseParams = TerrainMaterialSettings.GetPresetParameters(SelectedPreset);
            
            // Clone the preset to avoid modifying the static instance
            var result = new RoadSmoothingParameters
            {
                // Copy all settings from preset (or use defaults for Custom)
                Approach = baseParams?.Approach ?? RoadSmoothingApproach.Spline,
                EnableTerrainBlending = baseParams?.EnableTerrainBlending ?? true,
                CrossSectionIntervalMeters = baseParams?.CrossSectionIntervalMeters ?? 0.5f,
                BlendFunctionType = baseParams?.BlendFunctionType ?? BlendFunctionType.Cosine,
                
                // Post-processing smoothing
                EnablePostProcessingSmoothing = baseParams?.EnablePostProcessingSmoothing ?? true,
                SmoothingType = baseParams?.SmoothingType ?? PostProcessingSmoothingType.Gaussian,
                SmoothingKernelSize = baseParams?.SmoothingKernelSize ?? 7,
                SmoothingSigma = baseParams?.SmoothingSigma ?? 1.5f,
                SmoothingMaskExtensionMeters = baseParams?.SmoothingMaskExtensionMeters ?? 6.0f,
                SmoothingIterations = baseParams?.SmoothingIterations ?? 1,
                
                // Debug
                DebugOutputDirectory = debugOutputDirectory,
                ExportSmoothedHeightmapWithOutlines = baseParams?.ExportSmoothedHeightmapWithOutlines ?? false,
                
                // Override with prominent parameters
                RoadWidthMeters = RoadWidthMeters,
                TerrainAffectedRangeMeters = TerrainAffectedRangeMeters,
                RoadMaxSlopeDegrees = RoadMaxSlopeDegrees,
                SideMaxSlopeDegrees = SideMaxSlopeDegrees
            };
            
            // Copy SplineParameters if preset has them
            if (baseParams?.SplineParameters != null)
            {
                result.SplineParameters = new SplineRoadParameters
                {
                    SkeletonDilationRadius = baseParams.SplineParameters.SkeletonDilationRadius,
                    PreferStraightThroughJunctions = baseParams.SplineParameters.PreferStraightThroughJunctions,
                    JunctionAngleThreshold = baseParams.SplineParameters.JunctionAngleThreshold,
                    MinPathLengthPixels = baseParams.SplineParameters.MinPathLengthPixels,
                    BridgeEndpointMaxDistancePixels = baseParams.SplineParameters.BridgeEndpointMaxDistancePixels,
                    DensifyMaxSpacingPixels = baseParams.SplineParameters.DensifyMaxSpacingPixels,
                    SimplifyTolerancePixels = baseParams.SplineParameters.SimplifyTolerancePixels,
                    UseGraphOrdering = baseParams.SplineParameters.UseGraphOrdering,
                    OrderingNeighborRadiusPixels = baseParams.SplineParameters.OrderingNeighborRadiusPixels,
                    SplineTension = baseParams.SplineParameters.SplineTension,
                    SplineContinuity = baseParams.SplineParameters.SplineContinuity,
                    SplineBias = baseParams.SplineParameters.SplineBias,
                    SmoothingWindowSize = baseParams.SplineParameters.SmoothingWindowSize,
                    UseButterworthFilter = baseParams.SplineParameters.UseButterworthFilter,
                    ButterworthFilterOrder = baseParams.SplineParameters.ButterworthFilterOrder,
                    GlobalLevelingStrength = baseParams.SplineParameters.GlobalLevelingStrength,
                    ExportSplineDebugImage = baseParams.SplineParameters.ExportSplineDebugImage,
                    ExportSkeletonDebugImage = baseParams.SplineParameters.ExportSkeletonDebugImage,
                    ExportSmoothedElevationDebugImage = baseParams.SplineParameters.ExportSmoothedElevationDebugImage
                };
            }
            
            // Copy DirectMaskParameters if preset has them
            if (baseParams?.DirectMaskParameters != null)
            {
                result.DirectMaskParameters = new DirectMaskRoadParameters
                {
                    SmoothingWindowSize = baseParams.DirectMaskParameters.SmoothingWindowSize,
                    RoadPixelSearchRadius = baseParams.DirectMaskParameters.RoadPixelSearchRadius,
                    UseButterworthFilter = baseParams.DirectMaskParameters.UseButterworthFilter,
                    ButterworthFilterOrder = baseParams.DirectMaskParameters.ButterworthFilterOrder
                };
            }
            
            return result;
        }
    }
}
