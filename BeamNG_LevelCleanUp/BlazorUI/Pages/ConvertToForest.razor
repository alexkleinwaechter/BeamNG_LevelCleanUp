@page "/ConvertToForest"
@using System.IO.Compression
@using BeamNG_LevelCleanUp.BlazorUI.Components
@using BeamNG_LevelCleanUp.Communication
@using BeamNG_LevelCleanUp.Logic
@using BeamNG_LevelCleanUp.Objects
@using BeamNG_LevelCleanUp.Utils
@using static Utils.TreeExtensions;
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<ErrorBoundary>
    <ChildContent>
        <div class="content">
            <h3>Convert static assets to forest items</h3>
            <MudExpansionPanels @ref="FileSelect">
                <MudExpansionPanel Text="@GetBeamInstallDir()" Expanded="false">
                    <FileSelectComponent OnFileSelected="SetBeamInstallDir" SelectFolder="true"
                                         Description="The game install directory. If empty some features are missing.">
                    </FileSelectComponent>
                </MudExpansionPanel>
                <MudExpansionPanel Text="@GetFileSelectTitle()" Expanded="true">
                    <FileSelectComponent OnFileSelected="FileSelected"
                                         Description="Always use a copy of your project."
                                         Disabled="@_fileSelectDisabled">
                    </FileSelectComponent>
                    @if (_vanillaLevels.Any())
                    {
                        <MudSelect T="FileInfo" ToStringFunc="@converter"
                                   ValueChanged="OnVanillaSourceSelected"
                                   Label="Or select a vanilla level" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Clearable>
                            @foreach (var item in _vanillaLevels)
                            {
                                <MudSelectItem Value="@(item)">@item.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>
            @if (TreeItems.Any())
            {
                <MudTreeView T="ITree<Asset>" Items="TreeItems" Dense
                             SelectionMode="SelectionMode.MultiSelection" @bind-SelectedValues="SelectedTreeValues">
                    <ItemTemplate Context="treeItemData">
                        <MudTreeViewItem Items="@ConvertToTreeItemData(treeItemData.Value.Children)" Value="@treeItemData.Value"
                                         Text="@treeItemData.Value.Data.Name" @bind-Expanded="@treeItemData.Expanded"
                                         @bind-Selected="@treeItemData.Selected"/>
                    </ItemTemplate>
                </MudTreeView>
            }
            <MudDrawer @bind-Open="@_openDrawer" Width="@width" Height="@height" Anchor="@_anchor" Elevation="1" Variant="@DrawerVariant.Temporary">
                <MudList T="string" ReadOnly="false" Dense="true" Gutters="true">
                    @{
                        var list = _showErrorLog ? _errors : _showWarningLog ? _warnings : _messages;
                        @foreach (var item in list)
                        {
                            <MudListItem T="string" @key="@Guid.NewGuid()" Style="border-bottom:1px solid grey">
                                <MudText Typo="Typo.h6">@item</MudText>
                            </MudListItem>
                        }
                    }
                </MudList>
            </MudDrawer>
        </div>
        <footer>
            @if (_itemCount > 0)
            {
                <MudText>Items: @_itemCount, Selected: @SelectedValues.Count()</MudText>
            }
            <MudStack Row="true" Justify="Justify.SpaceBetween">
                @if (_errors.Any())
                {
                    <MudButton Color="Color.Error" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Error))">Errors</MudButton>
                }
                @if (_warnings.Any())
                {
                    <MudButton Color="Color.Warning" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Warning))">Warnings</MudButton>
                }
                @if (_messages.Any())
                {
                    <MudButton Color="Color.Info" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Info))">Messages</MudButton>
                }
                @if (SelectedValues.Any())
                {
                    <MudButton Color="Color.Primary" OnClick="@ConvertDialog">Convert to Forestitems</MudButton>
                }
                @if (_showDeployButton)
                {
                    <MudSelect Dense T="CompressionLevel" Label="Compression Level" AnchorOrigin="Origin.TopCenter"
                               @bind-Value="_compressionLevel">
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.Fastest"/>
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.NoCompression"/>
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.Optimal"/>
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.SmallestSize"/>
                    </MudSelect>
                    <MudButton @onclick="ZipAndDeploy" Color="Color.Primary">Build Zipfile</MudButton>
                }
            </MudStack>
            @if (!string.IsNullOrEmpty(ZipFileHandler.WorkingDirectory))
            {
                <MudButton @onclick="ZipFileHandler.OpenExplorer" StartIcon="@Icons.Material.Filled.FolderOpen" Variant="Variant.Text" Color="Color.Primary">Working Directory: @ZipFileHandler.WorkingDirectory</MudButton>
                <MudButton @onclick="ZipFileHandler.OpenExplorerLogs" StartIcon="@Icons.Material.Filled.FolderOpen" Variant="Variant.Text" Color="Color.Primary">Logfiles</MudButton>
            }
        </footer>
    </ChildContent>
    <ErrorContent>
        <CustomErrorContent/>
    </ErrorContent>
</ErrorBoundary>

@code {

    private string _levelName { get; set; }
    private string _levelPath { get; set; }
    private string _beamLogFilePath { get; set; } = string.Empty;
    private List<string> _missingFiles { get; set; } = new();
    private List<string> _errors { get; set; } = new();
    private List<string> _warnings { get; set; } = new();
    private List<string> _messages { get; set; } = new();
    private Snackbar _staticSnackbar;
    private BeamFileReader Reader { get; set; }
    private readonly string _fileSelectTitle = "Select your zipped level you want convert assets to forestitems";
    private bool _fileSelectDisabled { get; set; }
    private bool _fileSelectExpanded { get; set; }
    private bool _openDrawer;
    private Anchor _anchor;
    private string width, height;
    private List<GridFileListItem> BindingListDelete { get; set; } = new();
    private HashSet<GridFileListItem> _selectedItems = new();
    private bool _fixed_Header = true;
    private MudExpansionPanels? FileSelect { get; set; }
    private string _searchString = string.Empty;
    private string _labelFileSummaryShrink { get; set; } = string.Empty;
    private bool _showDeployButton { get; set; }
    private CompressionLevel _compressionLevel { get; set; } = CompressionLevel.Optimal;
    bool _showErrorLog { get; set; }
    bool _showWarningLog { get; set; }
    private List<FileInfo> _vanillaLevels { get; set; } = new();
    private FileInfo _vanillaLevelSourceSelected { get; set; }
    private string _beamInstallDir { get; set; }
    public ITree<Asset> VirtualRootNode { get; set; } = default!;
    private HashSet<ITree<Asset>> Items { get; set; } = new();
    private HashSet<TreeItemData<ITree<Asset>>> TreeItems { get; set; } = new();
    private IReadOnlyCollection<ITree<Asset>> _selectedTreeValues = new HashSet<ITree<Asset>>();

    public IReadOnlyCollection<ITree<Asset>> SelectedTreeValues
    {
        get => _selectedTreeValues;
        set
        {
            _selectedTreeValues = value;
            OnSelectedValuesChanged(value);
        }
    }

    public List<Asset> SelectedValues { get; set; } = new();
    private int _itemCount { get; set; }

    private HashSet<TreeItemData<ITree<Asset>>> ConvertToTreeItemData(HashSet<ITree<Asset>> items)
    {
        var result = new HashSet<TreeItemData<ITree<Asset>>>();
        foreach (var item in items)
        {
            var treeItemData = new TreeItemData<ITree<Asset>>
            {
                Value = item,
                Expanded = item.IsExpanded,
                Selected = item.IsSelected
            };
            result.Add(treeItemData);
        }

        return result;
    }

    protected async Task FileSelected(string file)
    {
        await (FileSelect?.CollapseAllAsync() ?? Task.CompletedTask);
        _labelFileSummaryShrink = string.Empty;
        _fileSelectDisabled = true;
        _levelName = null;
        _levelPath = null;
        _beamLogFilePath = null;
        _missingFiles = new List<string>();
        _errors = new List<string>();
        _warnings = new List<string>();
        _messages = new List<string>();
        _openDrawer = false;
        BindingListDelete = new List<GridFileListItem>();
        _showDeployButton = false;
        Reader = null;
        _vanillaLevelSourceSelected = null;

        // Copy file to centralized working directory if not already there
        var targetFile = Path.Join(ZipFileHandler.WorkingDirectory, Path.GetFileName(file));
        if (!file.Equals(targetFile, StringComparison.OrdinalIgnoreCase))
        {
            File.Copy(file, targetFile, true);
        }

        await Task.Run(() =>
        {
            try
            {
                _staticSnackbar = Snackbar.Add("Unzipping level...", Severity.Normal, config => { config.VisibleStateDuration = int.MaxValue; });
                _levelPath = ZipFileHandler.ExtractToDirectory(targetFile, "_unpacked");
                Snackbar.Add("Unzipping finished", Severity.Success);
                Snackbar.Remove(_staticSnackbar);
            }
            catch (Exception ex)
            {
                ShowException(ex);
                _fileSelectDisabled = false;
            }
        });

        await InitReaderAndTree();
        _fileSelectDisabled = false;
    }

    private async Task InitReaderAndTree()
    {
        _staticSnackbar = Snackbar.Add("Getting static items and build tree ...", Severity.Normal, config => { config.VisibleStateDuration = int.MaxValue; });

        await Task.Run(() =>
        {
            Reader = new BeamFileReader(_levelPath, string.Empty);
            _levelName = Reader.GetLevelName();
            var assets = Reader.ReadForConvertToForest();
            InvokeAsync(() => BuildTreeView(assets));
        });
        Snackbar.Remove(_staticSnackbar);
    }

    protected void BuildTreeView(List<Asset> assets)
    {
        VirtualRootNode = assets.ToTree((parent, child) => child.__parent == parent.Name, new List<Asset>());
        Items = VirtualRootNode.Children;
        TreeItems = ConvertToTreeItemData(Items);
        _itemCount = assets.Count(_ => _.DaeExists == true);
        StateHasChanged();
    }

    protected Task OnSelectedValuesChanged(IReadOnlyCollection<ITree<Asset>> values)
    {
        SelectedValues = values
            .Flatten(x => x.Children)
            .Select(_ => _.Data)
            .Where(_ => _.Class == "TSStatic")
            .Distinct()
            .ToList();
        return Task.CompletedTask;
    }

    private Task HandleSelectedValuesChanged()
    {
        // This will be called by the tree view
        return Task.CompletedTask;
    }

    protected void SetBeamInstallDir(string file)
    {
        if (file != Steam.BeamInstallDir)
        {
            Steam.BeamInstallDir = file;
            GetVanillaLevels();
        }
    }

    protected string GetBeamInstallDir()
    {
        if (Steam.BeamInstallDir != _beamInstallDir)
        {
            _beamInstallDir = Steam.GetBeamInstallDir();
            GetVanillaLevels();
        }

        return "BeamNG install directory: " + _beamInstallDir;
    }

    readonly Func<FileInfo, string> converter = p => p?.Name;

    protected async Task OnVanillaSourceSelected(FileInfo file)
    {
        //InitializeVariables();
        SetDefaultWorkingDirectory();
        _vanillaLevelSourceSelected = file;
        var target = Path.Join(ZipFileHandler.WorkingDirectory, _vanillaLevelSourceSelected.Name);
        PubSubChannel.SendMessage(PubSubMessageType.Info, $"Copy {_vanillaLevelSourceSelected.Name} to {target}");
        File.Copy(_vanillaLevelSourceSelected.FullName, target, true);
        _fileSelectDisabled = false;
        await FileSelected(target);
    }

    private void GetVanillaLevels()
    {
        if (!string.IsNullOrEmpty(_beamInstallDir))
        {
            var dir = Path.Join(Steam.BeamInstallDir, Constants.BeamMapPath);
            try
            {
                _vanillaLevels = Directory.GetFiles(dir)
                    .Where(x => x.EndsWith(".zip", StringComparison.OrdinalIgnoreCase))
                    .Select(x => new FileInfo(x)).ToList();
                StateHasChanged();
            }
            catch (Exception ex)
            {
            }
        }
    }

    public void SetDefaultWorkingDirectory()
    {
        AppPaths.EnsureWorkingDirectory();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckPreviousLevel();
        }
    }

    protected override void OnInitialized()
    {
        // IMPORTANT: Always reset to default working directory on page init
        AppPaths.EnsureWorkingDirectory();
        
        var consumer = Task.Run(async () =>
        {
            while (!StaticVariables.ApplicationExitRequest && await PubSubChannel.ch.Reader.WaitToReadAsync())
            {
                var msg = await PubSubChannel.ch.Reader.ReadAsync();
                if (!_messages.Contains(msg.Message) && !_errors.Contains(msg.Message))
                {
                    switch (msg.MessageType)
                    {
                        case PubSubMessageType.Info:
                            _messages.Add(msg.Message);
                            Snackbar.Add(msg.Message, Severity.Info);
                            break;
                        case PubSubMessageType.Warning:
                            _warnings.Add(msg.Message);
                            Snackbar.Add(msg.Message, Severity.Warning);
                            break;

                        case PubSubMessageType.Error:
                            _errors.Add(msg.Message);
                            Snackbar.Add(msg.Message, Severity.Error);
                            break;
                    }
                }
            }
        });
    }

    async Task CheckPreviousLevel()
    {
        var bfr = new BeamFileReader();
        _levelName = bfr.GetLevelName();
        _levelPath = bfr.GetLevelPath();
        if (!string.IsNullOrEmpty(_levelName) && !string.IsNullOrEmpty(_levelPath))
        {
            _staticSnackbar
                = Snackbar.Add($"The level {_levelName} is still loaded. You can either use it now or load another level for conversion.",
                    Severity.Info);
            await UseLoadedLevelDialog();
        }
        else
        {
            _fileSelectExpanded = true;
        }
    }

    void OpenDrawer(Anchor anchor, PubSubMessageType msgType)
    {
        _showErrorLog = msgType == PubSubMessageType.Error;
        _showWarningLog = msgType == PubSubMessageType.Warning;
        _openDrawer = true;
        _anchor = anchor;

        switch (anchor)
        {
            case Anchor.Start:
                width = "300px";
                height = "100%";
                break;
            case Anchor.End:
                width = "400px";
                height = "100%";
                break;
            case Anchor.Bottom:
                width = "100%";
                height = "200px";
                break;
            case Anchor.Top:
                width = "100%";
                height = "350px";
                break;
        }
    }

    private void ShowException(Exception ex)
    {
        var message = ex.InnerException != null ? ex.Message + $" {ex.InnerException}" : ex.Message;
        Snackbar.Add(message, Severity.Error);
        _errors.Add(message);
    }

    private string GetFileSelectTitle()
    {
        if (!string.IsNullOrEmpty(_levelName))
        {
            return $"{_fileSelectTitle} > {_levelName}";
        }

        return $"{_fileSelectTitle}";
    }

    private async Task ConvertDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Do you really want to convert the selected static assets to forest items? Please always use a copy of your project with this tool!");
        parameters.Add("ButtonText", "Convert to forest items");
        parameters.Add("Color", Color.Warning);
        var dialog = await DialogService.ShowAsync<SimpleDialog>("Convert assets", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            _staticSnackbar = Snackbar.Add("Converting to forest items...", Severity.Normal, config => { config.VisibleStateDuration = int.MaxValue; });
            try
            {
                await Task.Run(() => { Reader.ConvertToForest(SelectedValues); });
            }
            catch (Exception ex)
            {
                Snackbar.Remove(_staticSnackbar);
                ShowException(ex);
            }

            Snackbar.Remove(_staticSnackbar);
            await DeleteDialog();
            _showDeployButton = true;
            SelectedValues.Clear();
            Items.Clear();
            TreeItems.Clear();
            
            // Write operation logs (info, warnings, errors)
            Reader.WriteOperationLogs(_messages, _warnings, _errors, "ForestConvert");
            
            PubSubChannel.SendMessage(PubSubMessageType.Info, "Conversion done! You can build your deployment file now.");
        }
    }

    private async Task DeleteDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Do you want to to delete the static assets from the missiongroups? If not you have the assets duplicated. One in the tree and one as forestitem.");
        parameters.Add("ButtonText", "Delete from Missiongroups");
        parameters.Add("Color", Color.Warning);
        var dialog = await DialogService.ShowAsync<SimpleDialog>("Delete assets from Missiongroups", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try
            {
                await Task.Run(() => { Reader.DeleteFromMissiongroups(SelectedValues); });
            }
            catch (Exception ex)
            {
                ShowException(ex);
            }
        }
    }

    private async Task UseLoadedLevelDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters();
        parameters.Add("ContentText", $"The level {_levelName} is already loaded from a previous task. Do you want to use it for the conversion of assets to forestitems?");
        parameters.Add("ButtonText", "Yes");
        parameters.Add("Color", Color.Default);
        var dialog = await DialogService.ShowAsync<SimpleDialog>("Use loaded level for conversion", parameters, options);
        var result = await dialog.Result;
        dialog.Close();
        if (!result.Canceled)
        {
            try
            {
                await InitReaderAndTree();
            }
            catch (Exception ex)
            {
                ShowException(ex);
            }
        }
    }


    private async Task ZipAndDeploy()
    {
        var path = string.Empty;
        if (!string.IsNullOrEmpty(_levelPath))
        {
            try
            {
                path = ZipFileHandler.GetLastUnpackedPath();
                _staticSnackbar = Snackbar.Add("Zipping the deployment file. Please be patient.", Severity.Normal, config => { config.VisibleStateDuration = int.MaxValue; });
                await Task.Run(() => { ZipFileHandler.BuildDeploymentFile(path, _levelName, _compressionLevel); });
                Snackbar.Remove(_staticSnackbar);
            }
            catch (Exception ex)
            {
                ShowException(ex);
            }
        }
    }

}}