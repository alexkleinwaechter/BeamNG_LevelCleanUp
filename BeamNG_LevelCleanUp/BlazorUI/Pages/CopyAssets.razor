@page "/CopyAssets"
@using System.Diagnostics.CodeAnalysis
@using System.IO.Compression
@using System.Reflection
@using BeamNG_LevelCleanUp.BlazorUI.Components
@using BeamNG_LevelCleanUp.Communication
@using BeamNG_LevelCleanUp.Logic
@using BeamNG_LevelCleanUp.Objects
@using BeamNG_LevelCleanUp.Utils
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<ErrorBoundary>
    <ChildContent>
        <div class="content">
            <h3>Copy Assets</h3>
            <MudExpansionPanels @ref="FileSelect">
                <MudExpansionPanel Text="@GetBeamInstallDir()" Expanded="false">
                    <FileSelectComponent OnFileSelected="SetBeamInstallDir" SelectFolder="true"
                                         Description="The game install directory. If empty some features are missing.">
                    </FileSelectComponent>
                </MudExpansionPanel>
                <MudExpansionPanel Text="@GetFileSelectTitleCopyFrom()" Expanded="true">
                    <FileSelectComponent OnFileSelected="FileSelectedCopyFrom"
                                         Description="Your asset source map"
                                         Disabled="@GetFileSelectDisabled()">
                    </FileSelectComponent>
                    @if (_vanillaLevels.Any())
                    {
                        <MudSelect T="FileInfo" ToStringFunc="@converter"
                                   ValueChanged="OnVanillaSourceSelected"
                                   Value="@_vanillaLevelSourceSelected"
                                   Label="Or select a vanilla level" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Clearable
                                   Disabled="@GetFileSelectDisabled()">
                            @foreach (var item in _vanillaLevels)
                            {
                                <MudSelectItem Value="@(item)">@item.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                </MudExpansionPanel>
                <MudExpansionPanel Text="@GetFileSelectTitle()" Expanded="false">
                    <FileSelectComponent OnFileSelected="@(x => FileSelected(x, false))"
                                         Description="Your zipped target map"
                                         Disabled="@GetFileSelectDisabled()">
                    </FileSelectComponent>
                    <FileSelectComponent OnFileSelected="@(x => FileSelected(x, true))" SelectFolder="true"
                                         Description="or your unzipped map directory"
                                         Disabled="@GetFileSelectDisabled()">
                    </FileSelectComponent>

                    @if (_vanillaLevels.Any())
                    {
                        <MudSelect T="FileInfo" ToStringFunc="@converter"
                                   Disabled="@GetFileSelectDisabled()"
                                   ValueChanged="OnVanillaTargetSelected"
                                   Value="@_vanillaLevelTargetSelected"
                                   Label="Or select a vanilla level" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Clearable>
                            @foreach (var item in _vanillaLevels)
                            {
                                <MudSelectItem Value="@(item)">@item.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>

            @if (!string.IsNullOrEmpty(_levelName) && !string.IsNullOrEmpty(_levelNameCopyFrom))
            {
                <MudButton @onclick="ResetPage" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Refresh" Style="margin-top: 16px;">
                    Reset and Select Different Maps
                </MudButton>
            }

            @if (_copyCompleted)
            {
                <MudAlert Severity="Severity.Success" Class="mt-4 mb-4" Icon="@Icons.Material.Filled.CheckCircle" ShowCloseIcon="true" CloseIconClicked="@(() => _copyCompleted = false)">
                    <MudText Typo="Typo.h6">Copy Completed Successfully!</MudText>
                    <MudText Typo="Typo.body2">
                        Copied <b>@_copiedAssetsCount</b> asset(s) from <b>@_lastCopiedSourceName</b> to <b>@_levelName</b>.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        You can now select another source map to copy additional assets, or build the zip file.
                    </MudText>
                    <MudButton @onclick="ResetSourceMap" 
                              Color="Color.Primary" 
                              Variant="Variant.Filled"
                              StartIcon="@Icons.Material.Filled.AddCircle" 
                              Class="mt-3">
                        Select Another Source Map
                    </MudButton>
                </MudAlert>
            }

            @if (BindingListCopy.Any())
            {
                <MudTable @ref="table" T="GridFileListItem" Hover="true" ServerData="LoadServerData"
                          MultiSelection="true" @bind-SelectedItems="_selectedItems">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Found Assets in @_levelNameCopyFrom</MudText>
                        <MudSpacer/>
                        <MudTextField DebounceInterval="300" Clearable T="string" ValueChanged="@(s => OnSearch(s))" Immediate="true" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>View</MudTh>
                        <MudTh>
                            <MudTableSortLabel SortBy="new Func<GridFileListItem, object>(x => x.AssetType)">Assettype</MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel SortBy="new Func<GridFileListItem, object>(x => x.FullName)">File</MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel SortBy="new Func<GridFileListItem, object>(x => x.Duplicate)">Duplicate</MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel SortBy="new Func<GridFileListItem, object>(x => x.DuplicateFrom)">Duplicate found in</MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel SortBy="new Func<GridFileListItem, object>(x => x.SizeMb)">Size Mb</MudTableSortLabel>
                        </MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Pageview" OnClick="() => OpenAssetViewer(context)"></MudIconButton>
                        </MudTd>
                        <MudTd DataLabel="File">@context.AssetType</MudTd>
                        <MudTd DataLabel="File">@context.FullName</MudTd>
                        <MudTd DataLabel="File">@context.Duplicate</MudTd>
                        <MudTd DataLabel="File">@context.DuplicateFrom</MudTd>
                        <MudTd DataLabel="Size">@context.SizeMb</MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else if (!string.IsNullOrEmpty(_levelPath) && !_errors.Any())
            {
                <MudText Color="Color.Warning">No assets found.</MudText>
            }

            <MudDrawer @bind-Open="@_openDrawer" Width="@width" Height="@height" Anchor="@_anchor" Elevation="1" Variant="@DrawerVariant.Temporary">
                <MudList T="string" ReadOnly="false" Dense="true" Gutters="true">
                    @{
                        var list = _showErrorLog ? _errors : _showWarningLog ? _warnings : _messages;
                        @foreach (var item in list)
                        {
                            <MudListItem T="string" @key="@Guid.NewGuid()" Style="border-bottom:1px solid grey">
                                <MudText Typo="Typo.h6">@item</MudText>
                            </MudListItem>
                        }
                    }
                </MudList>
            </MudDrawer>
        </div>
        <footer>
            @if (_selectedItems.Any())
            {
                <MudText>Files: @BindingListCopy?.Count, Selected: @_selectedItems.Count(), Sum Size MB: @Math.Round(_selectedItems.Sum(x => x.SizeMb), 2)</MudText>
            }
            <MudStack Row="true" Justify="Justify.SpaceBetween">
                @if (_selectedItems.Any())
                {
                    <MudButton @onclick="CopyDialog" Color="Color.Primary">Copy Assets</MudButton>
                }
                @if (_errors.Any())
                {
                    <MudButton Color="Color.Error" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Error))">Errors</MudButton>
                }
                @if (_warnings.Any())
                {
                    <MudButton Color="Color.Warning" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Warning))">Warnings</MudButton>
                }
                @if (_messages.Any())
                {
                    <MudButton Color="Color.Info" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Info))">Messages</MudButton>
                }
                @if (_showDeployButton)
                {
                    <MudSelect Dense T="CompressionLevel" Label="Compression Level" AnchorOrigin="Origin.TopCenter"
                               @bind-Value="_compressionLevel">
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.Fastest"/>
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.NoCompression"/>
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.Optimal"/>
                        <MudSelectItem T="CompressionLevel" Value="CompressionLevel.SmallestSize"/>
                    </MudSelect>
                    <MudButton @onclick="ZipAndDeploy" Color="Color.Primary">Build Zipfile</MudButton>
                }
            </MudStack>
            @if (!string.IsNullOrEmpty(ZipFileHandler.WorkingDirectory))
            {
                <MudButton @onclick="ZipFileHandler.OpenExplorer" StartIcon="@Icons.Material.Filled.FolderOpen" Variant="Variant.Text" Color="Color.Primary">Working Directory: @ZipFileHandler.WorkingDirectory</MudButton>
                <MudButton @onclick="ZipFileHandler.OpenExplorerLogs" StartIcon="@Icons.Material.Filled.FolderOpen" Variant="Variant.Text" Color="Color.Primary">Logfiles</MudButton>
            }
        </footer>
    </ChildContent>
    <ErrorContent>
        <CustomErrorContent/>
    </ErrorContent>
</ErrorBoundary>