@page "/CreateLevel"
@using System.IO.Compression
@using BeamNG_LevelCleanUp.BlazorUI.Components
@using BeamNG_LevelCleanUp.Communication
@using BeamNG_LevelCleanUp.Logic
@using BeamNG_LevelCleanUp.LogicCopyAssets
@using BeamNG_LevelCleanUp.Objects
@using BeamNG_LevelCleanUp.Utils
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<ErrorBoundary>
    <ChildContent>
        <div class="content">
            <h3>Create New BeamNG Level</h3>
            
            <MudExpansionPanels @ref="FileSelect">
                <MudExpansionPanel Text="@GetBeamInstallDir()" Expanded="false">
                    <FileSelectComponent OnFileSelected="SetBeamInstallDir" SelectFolder="true"
                                        Description="The game install directory. If empty some features are missing.">
                    </FileSelectComponent>
                </MudExpansionPanel>
                
                <MudExpansionPanel Text="@GetSourceMapTitle()" Expanded="@(!_wizardState.Step1_SetupComplete)">
                    <FileSelectComponent OnFileSelected="OnSourceMapSelected"
                                        Description="Select a source map to copy base level data from"
                                        Disabled="@(_wizardState.Step1_SetupComplete)">
                    </FileSelectComponent>
                    
                    @if (_vanillaLevels.Any())
                    {
                        <MudSelect T="FileInfo" ToStringFunc="@converter"
                                  ValueChanged="OnVanillaSourceSelected"
                                  Value="@_vanillaLevelSourceSelected"
                                  Label="Or select a vanilla level" 
                                  AnchorOrigin="Origin.BottomCenter" 
                                  Variant="Variant.Outlined" 
                                  Clearable
                                  Disabled="@(_wizardState.Step1_SetupComplete)">
                            @foreach (var item in _vanillaLevels)
                            {
                                <MudSelectItem Value="@(item)">@item.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>

            @if (!string.IsNullOrEmpty(_sourceLevelName) && !_wizardState.Step1_SetupComplete)
            {
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">New Level Configuration</MudText>
                    
                    <MudTextField @bind-Value="_targetLevelPath" 
                                 Label="Level Path (folder name)" 
                                 HelperText="e.g., my_custom_map (lowercase, no spaces)"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 Immediate="true"
                                 Class="mb-4"/>
                    
                    <MudTextField @bind-Value="_targetLevelName" 
                                 Label="Level Display Name" 
                                 HelperText="e.g., My Custom Map"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 Immediate="true"
                                 Class="mb-4"/>
                    
                    <MudTextField @bind-Value="_levelDescription" 
                                 Label="Description" 
                                 HelperText="A brief description of your level"
                                 Variant="Variant.Outlined"
                                 Lines="2"
                                 Class="mb-4"/>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_levelCountry" 
                                         Label="Country" 
                                         HelperText="e.g., USA, Germany, Japan"
                                         Variant="Variant.Outlined"
                                         Class="mb-4"/>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_levelRegion" 
                                         Label="Region" 
                                         HelperText="e.g., California, Bavaria"
                                         Variant="Variant.Outlined"
                                         Class="mb-4"/>
                        </MudItem>
                    </MudGrid>
                    
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_levelBiome" 
                                         Label="Biome" 
                                         HelperText="e.g., Desert, Forest, Urban"
                                         Variant="Variant.Outlined"
                                         Class="mb-4"/>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_levelRoads" 
                                         Label="Roads" 
                                         HelperText="e.g., Paved, Dirt, Mixed"
                                         Variant="Variant.Outlined"
                                         Class="mb-4"/>
                        </MudItem>
                    </MudGrid>
                    
                    <MudTextField @bind-Value="_levelSuitableFor" 
                                 Label="Suitable For" 
                                 HelperText="e.g., Racing, Off-road, Cruising"
                                 Variant="Variant.Outlined"
                                 Class="mb-4"/>
                    
                    <MudTextField @bind-Value="_levelFeatures" 
                                 Label="Features" 
                                 HelperText="e.g., Traffic, AI paths, Scenarios"
                                 Variant="Variant.Outlined"
                                 Class="mb-4"/>
                    
                    <MudTextField @bind-Value="_levelAuthors" 
                                 Label="Authors" 
                                 HelperText="Your name or team name"
                                 Variant="Variant.Outlined"
                                 Class="mb-4"/>
                    
                    <MudSelect T="int" 
                              @bind-Value="_wizardState.TerrainSize" 
                              Label="Terrain Size" 
                              HelperText="Size of the terrain in meters (power of 2)"
                              Variant="Variant.Outlined"
                              Class="mb-4">
                        <MudSelectItem Value="256">256 x 256</MudSelectItem>
                        <MudSelectItem Value="512">512 x 512</MudSelectItem>
                        <MudSelectItem Value="1024">1024 x 1024</MudSelectItem>
                        <MudSelectItem Value="2048">2048 x 2048 (Default)</MudSelectItem>
                        <MudSelectItem Value="4096">4096 x 4096</MudSelectItem>
                        <MudSelectItem Value="8192">8192 x 8192</MudSelectItem>
                        <MudSelectItem Value="16384">16384 x 16384</MudSelectItem>
                    </MudSelect>
                    
                    <MudButton OnClick="@InitializeNewLevel" 
                              Color="Color.Primary" 
                              Variant="Variant.Filled"
                              Disabled="@(!CanInitialize())"
                              StartIcon="@Icons.Material.Filled.Create">
                        Initialize New Level
                    </MudButton>
                </MudPaper>
            }

            @if (_wizardState.Step2_MissionGroupsCopied)
            {
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Class="mr-2"/>
                        Level Initialized Successfully
                    </MudText>
                    
                    <MudText Typo="Typo.body1" Class="mb-4">
                        Your new level "@_wizardState.LevelName" has been created at: <b>@_wizardState.TargetLevelPath</b>
                    </MudText>
                    
                    <MudDivider Class="my-4"/>
                    
                    <MudText Typo="Typo.h6" Class="mb-2">Copied Base Level Objects:</MudText>
                    <MudList T="string" Dense="true">
                        @foreach(var assetGroup in _wizardState.CopiedMissionGroupAssets.GroupBy(a => a.Class))
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Layers">
                                <b>@assetGroup.Key</b>: @assetGroup.Count() object(s)
                            </MudListItem>
                        }
                    </MudList>
                    
                    @if (_wizardState.CopiedFiles.Any())
                    {
                        <MudText Typo="Typo.body2" Class="mt-2">
                            <MudIcon Icon="@Icons.Material.Filled.FileCopy" Size="Size.Small" Class="mr-1"/>
                            @_wizardState.CopiedFiles.Count file(s) copied
                        </MudText>
                    }
                    
                    <MudDivider Class="my-4"/>
                    
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        <b>Next Step:</b> Select terrain materials for your level. Click "Select Terrain Materials" in the wizard below.
                    </MudAlert>
                </MudPaper>
            }

            @if (_wizardState.Step3_TerrainMaterialsSelected && !_wizardState.Step4_ForestBrushesSelected)
            {
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Terrain" Color="Color.Success" Class="mr-2"/>
                        Terrain Materials Copied
                    </MudText>
                    
                    <MudList T="string" Dense="true">
                        @foreach(var material in _wizardState.CopiedTerrainMaterials)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Landscape">
                                @material.Name
                            </MudListItem>
                        }
                    </MudList>
                    
                    <MudDivider Class="my-4"/>
                    
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        <b>Next Step:</b> Select forest brushes for your level. Click "Select Forest Brushes" in the wizard below.
                    </MudAlert>
                </MudPaper>
            }

            @if (_wizardState.Step4_ForestBrushesSelected)
            {
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Terrain" Color="Color.Success" Class="mr-2"/>
                        Terrain Materials Copied
                    </MudText>
                    
                    <MudList T="string" Dense="true">
                        @foreach(var material in _wizardState.CopiedTerrainMaterials)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Landscape">
                                @material.Name
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
                
                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Forest" Color="Color.Success" Class="mr-2"/>
                        Forest Brushes Copied
                    </MudText>
                    
                    <MudList T="string" Dense="true">
                        @foreach(var brush in _wizardState.CopiedForestBrushes)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Grass">
                                @brush
                            </MudListItem>
                        }
                    </MudList>
                    
                    <MudDivider Class="my-4"/>
                    
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        <b>Level Creation Complete!</b> Your level is ready with terrain materials and forest brushes.
                    </MudAlert>
                    
                    <MudStack Row="true" Class="mt-4">
                        <MudButton OnClick="@ZipAndDeploy" 
                                  Color="Color.Primary" 
                                  Variant="Variant.Filled"
                                  StartIcon="@Icons.Material.Filled.Archive">
                            Build Deployment ZIP
                        </MudButton>
                        
                        <MudButton OnClick="@CopyToLevelsFolder" 
                                  Color="Color.Success" 
                                  Variant="Variant.Filled"
                                  StartIcon="@Icons.Material.Filled.Folder">
                            Copy to BeamNG Levels Folder
                        </MudButton>
                        
                        <MudButton OnClick="@ResetWizard" 
                                  Color="Color.Default" 
                                  Variant="Variant.Outlined"
                                  StartIcon="@Icons.Material.Filled.Refresh">
                            Create Another Level
                        </MudButton>
                    </MudStack>
                </MudPaper>
            }

            <MudDrawer @bind-Open="@_openDrawer" Width="@width" Height="@height" Anchor="@_anchor" Elevation="1" Variant="@DrawerVariant.Temporary">
                <MudList T="string" ReadOnly="false" Dense="true" Gutters="true">
                    @{
                        var list = _showErrorLog ? _errors : _showWarningLog ? _warnings : _messages;
                        @foreach (var item in list)
                        {
                            <MudListItem T="string" @key="@Guid.NewGuid()" Style="border-bottom:1px solid grey">
                                <MudText Typo="Typo.h6">@item</MudText>
                            </MudListItem>
                        }
                    }
                </MudList>
            </MudDrawer>
        </div>
        
        <footer>
            <MudStack Row="true" Justify="Justify.SpaceBetween">
                @if (_errors.Any())
                {
                    <MudButton Color="Color.Error" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Error))">
                        Errors (@_errors.Count)
                    </MudButton>
                }
                @if (_warnings.Any())
                {
                    <MudButton Color="Color.Warning" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Warning))">
                        Warnings (@_warnings.Count)
                    </MudButton>
                }
                @if (_messages.Any())
                {
                    <MudButton Color="Color.Info" OnClick="@(() => OpenDrawer(Anchor.Bottom, PubSubMessageType.Info))">
                        Messages (@_messages.Count)
                    </MudButton>
                }
            </MudStack>
            
            @if (!string.IsNullOrEmpty(ZipFileHandler.WorkingDirectory))
            {
                <MudButton @onclick="ZipFileHandler.OpenExplorer" 
                          StartIcon="@Icons.Material.Filled.FolderOpen" 
                          Variant="Variant.Text" 
                          Color="Color.Primary">
                    Working Directory: @ZipFileHandler.WorkingDirectory
                </MudButton>
            }
        </footer>
        
        <!-- Wizard Assistant Component -->
        <CascadingValue Value="_wizardState">
            <CreateLevelAssistant />
        </CascadingValue>
    </ChildContent>
    <ErrorContent>
        <CustomErrorContent/>
    </ErrorContent>
</ErrorBoundary>