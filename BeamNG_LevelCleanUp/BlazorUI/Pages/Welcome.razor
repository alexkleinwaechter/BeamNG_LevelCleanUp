@page "/"
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@using Microsoft.JSInterop
@inject IJSRuntime JS

<ErrorBoundary>
    <ChildContent>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2 mb-5">
            All processing uses a temp folder &mdash; source ZIPs stay untouched.
        </MudText>

        @* Featured Tools *@
        <MudGrid Spacing="4" Class="mb-6">
            @foreach (var tool in _featured)
            {
                <MudItem xs="12" md="4">
                    <MudCard Class="tool-card tool-card--featured" @onclick="() => NavigateTo(tool.Route)"
                             Style="@($"height: 100%; cursor: pointer; border-left: 3px solid {tool.Color};")">
                        <MudCardContent Class="pa-5">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@tool.Icon" Style="@($"color: {tool.Color};")" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@tool.Title</MudText>
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@tool.Description</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* More Tools *@
        <MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px;">More Tools</MudText>
        <MudGrid Spacing="3" Class="mb-6">
            @foreach (var tool in _more)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="tool-card" Style="height: 100%; cursor: pointer;" @onclick="() => NavigateTo(tool.Route)">
                        <MudCardContent Class="pa-4">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@tool.Icon" Size="Size.Small" Style="@($"color: {tool.Color};")" />
                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">@tool.Title</MudText>
                                @if (tool.IsExperimental)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">Beta</MudChip>
                                }
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@tool.Description</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* Companion Mods *@
        <MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px;">Companion World-Editor Mods</MudText>
        <MudGrid Spacing="3" Class="mb-6">
            @foreach (var mod in _companionMods)
            {
                <MudItem xs="12" sm="6">
                    <MudCard Class="tool-card" Style="height: 100%; cursor: pointer;" @onclick="() => OpenLink(mod.Url)">
                        <MudCardContent Class="pa-4">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@mod.Icon" Size="Size.Small" Style="@($"color: {mod.Color};")" />
                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">@mod.Title</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Color="Color.Secondary" />
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@mod.Description</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* Getting Started Tutorial *@
        <MudText Typo="Typo.overline" Class="mb-3" Style="letter-spacing: 1.5px;">Getting Started</MudText>
        <MudGrid Spacing="3" Class="mb-6">
            <MudItem xs="12" sm="6">
                <MudCard Class="tool-card" Style="height: 100%; cursor: pointer;" @onclick="OpenRealWorldMapTutorial">
                    <MudCardContent Class="pa-4">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Small" Style="color: #4caf50;" />
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">Real-World Map Tutorial</MudText>
                        </MudStack>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Step-by-step guide to creating a BeamNG level from real-world elevation data, OSM roads, and terrain materials.</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        @* Footer Links *@
        <MudDivider Class="my-4" />
        <MudStack Row="true" Justify="Justify.Center" Spacing="4" Class="mb-4">
            <MudLink Href="https://www.beamng.com/threads/beamng-tool-for-map-creators-updated-2025-11-15.89058/" Target="_blank" Color="Color.Primary">
                <MudIcon Icon="@Icons.Material.Filled.Forum" Class="mr-1" Size="Size.Small" /> BeamNG Forums
            </MudLink>
            <MudLink Href="https://github.com/alexkleinwaechter/BeamNG_LevelCleanUp" Target="_blank" Color="Color.Primary">
                <MudIcon Icon="@Icons.Custom.Brands.GitHub" Class="mr-1" Size="Size.Small" /> GitHub
            </MudLink>
        </MudStack>
    </ChildContent>
    <ErrorContent>
        <CustomErrorContent />
    </ErrorContent>
</ErrorBoundary>

<style>
    .tool-card {
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        border: 1px solid transparent;
    }

    .tool-card:hover {
        border-color: var(--mud-palette-primary);
    }

    .tool-card--featured:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
    }
</style>

@code {
    private record ToolInfo(string Title, string Description, string Icon, string Route, string Color, bool IsExperimental = false);
    private record ModInfo(string Title, string Description, string Icon, string Url, string Color);

    private readonly List<ToolInfo> _featured =
    [
        new("Create Level Wizard", "Guided wizard to set up a new level with terrain, materials, and assets from any source map.", Icons.Material.Filled.AddCircle, "/CreateLevel", "#4caf50"),
        new("Generate Terrain", "Create .ter files from PNG heightmaps or GeoTIFF with smooth OSM roads and material layers.", Icons.Material.Filled.Terrain, "/GenerateTerrain", "#2196f3"),
        new("Map Shrinker", "Remove orphaned files and unused assets to create lean deployment packages.", Icons.Material.Filled.Compress, "/MapShrink", "#ff9800")
    ];

    private readonly List<ToolInfo> _more =
    [
        new("Rename Map", "Change map name in filesystem and internal references", Icons.Material.Filled.DriveFileRenameOutline, "/RenameMap", "#9c27b0"),
        new("Copy Assets", "Copy decalroads, decals, and DAE assets between maps", Icons.Material.Filled.ContentCopy, "/CopyAssets", "#00bcd4"),
        new("Copy Terrain Materials", "Copy or replace terrain materials with groundcover support", Icons.Material.Filled.Layers, "/CopyTerrains", "#795548"),
        new("Copy Forest Brushes", "Copy forest items and all dependencies", Icons.Material.Filled.Forest, "/CopyForestBrushes", "#8bc34a"),
        new("Convert to Forest", "Convert TSStatic assets to forest items", Icons.Material.Filled.Transform, "/ConvertToForest", "#607d8b"),
        new("Utilities", "Move map position together with all objects", Icons.Material.Filled.Build, "/Utilities", "#78909c")
    ];

    private readonly List<ModInfo> _companionMods =
    [
        new("Load and Save Mastersplines", "The companion mod for loading the master splines resulting from the terrain generation feature. All mastersplines of the road network are available in BeamNG with this mod.", Icons.Material.Filled.Route, "https://www.beamng.com/threads/experimental-load-and-save-mastersplines.107762/", "#e91e63"),
        new("Replicate Lights and Objects", "A BeamNG.drive world editor extension that automatically replicates lights and TSStatic objects relative to template shapes throughout your map.", Icons.Material.Filled.ContentCopy, "https://www.beamng.com/threads/replicate-lights-and-objects-world-editor-plugin.106833/", "#ff5722")
    ];

    private void NavigateTo(string route)
    {
        NavigationManager.NavigateTo(route);
    }

    private async Task OpenLink(string url)
    {
        await JS.InvokeVoidAsync("window.open", url, "_blank");
    }

    private async Task OpenRealWorldMapTutorial()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true,
            CloseButton = true
        };
        await DialogService.ShowAsync<BeamNG_LevelCleanUp.BlazorUI.Components.RealWorldMapTutorialDialog>("Real-World Map Tutorial", options);
    }

    protected override void OnInitialized()
    {
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
        Snackbar.Configuration.MaxDisplayedSnackbars = 50;
        Snackbar.Configuration.HideTransitionDuration = 300;
        Snackbar.Configuration.ShowTransitionDuration = 300;
        Snackbar.Configuration.VisibleStateDuration = 5000;
    }
}