<?xml version="1.0" encoding="UTF-8"?>
<!--
  BeamNG Mapping Tools  WiX v5 Installer
  
  This installer packages the application with GDAL native libraries in a proper folder structure,
  which is required for GDAL to find its drivers and projection data (proj.db).
  
  Build: dotnet build Installer\BeamNG_LevelCleanUp.Installer.wixproj -c Release
  
  Installs to: C:\Program Files\BeamNG Mapping Tools
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="BeamNG Mapping Tools" 
           Manufacturer="Alexander Kleinwaechter" 
           Version="$(ProductVersion)" 
           UpgradeCode="E9D4C8B2-1A5F-4C7E-B8D9-3E6F2A8C5D1B"
           Scope="perMachine"
           InstallerVersion="500">
    
    <SummaryInformation Description="BeamNG.drive Map Building Tools with GeoTIFF Support" 
                        Manufacturer="Alex Kleinwaechter" />
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." 
                  Schedule="afterInstallValidate" 
                  AllowSameVersionUpgrades="yes" />
    
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />
    
    <!-- UI with launch application checkbox -->
    <UI Id="UI">
      <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="LaunchApplication"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
      <Property Id="WixShellExecTarget" Value="[#MainExecutable]" />
    </UI>
    
    <!-- Custom license file for the license agreement dialog -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    
    <!-- Checkbox text on the finish dialog -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch BeamNG Mapping Tools" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />

    <!-- Custom action to launch the application after install using WiX Util extension -->
    <CustomAction Id="LaunchApplication"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixShellExec"
                  Impersonate="yes" />
    
    <!-- Custom action to remove AppData folders on uninstall using PowerShell -->
    <!-- This removes both BeamNG_LevelCleanUp and BeamNG_LevelCleanUp.WebView2 folders from LocalAppData -->
    <SetProperty Id="RemoveAppDataFolders" 
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$folders = @('BeamNG_LevelCleanUp', 'BeamNG_LevelCleanUp.WebView2'); foreach ($f in $folders) { $path = Join-Path $env:LOCALAPPDATA $f; if (Test-Path $path) { Remove-Item $path -Recurse -Force -ErrorAction SilentlyContinue } }&quot;"
                 Before="RemoveAppDataFolders"
                 Sequence="execute" />
    
    <CustomAction Id="RemoveAppDataFolders"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Impersonate="yes"
                  Return="ignore" />
    
    <InstallExecuteSequence>
      <Custom Action="RemoveAppDataFolders" After="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>
    
    <Feature Id="MainApplication" Title="BeamNG Mapping Tools" Level="1">
      <ComponentGroupRef Id="AppComponents" />
      <ComponentRef Id="MainExeComponent" />
      <ComponentRef Id="ProgramMenuShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="AppDataCleanupComponent" />
    </Feature>
    
  </Package>

  <!-- Directory structure -->
  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="BeamNG Mapping Tools" />
    </StandardDirectory>
    
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="BeamNG Mapping Tools" />
    </StandardDirectory>
    
    <StandardDirectory Id="DesktopFolder" />
  </Fragment>

  <!-- Main executable component with known ID for launch action -->
  <Fragment>
    <Component Id="MainExeComponent" Guid="C3D4E5F6-A7B8-9012-C3D4-E5F6A7B89012" Directory="INSTALLFOLDER" Bitness="always64">
      <File Id="MainExecutable" 
            Source="..\BeamNG_LevelCleanUp\bin\Release\net9.0-windows10.0.17763.0\win-x64\publish\BeamNG_LevelCleanUp.exe"
            KeyPath="yes" />
    </Component>
  </Fragment>

  <!-- Shortcut components with Bitness set to always64 -->
  <Fragment>
    <Component Id="ProgramMenuShortcut" Guid="A1B2C3D4-E5F6-7890-A1B2-C3D4E5F67890" Directory="ApplicationProgramsFolder" Bitness="always64">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="BeamNG Mapping Tools"
                Description="Tools for BeamNG.drive map building with GeoTIFF support"
                Target="[INSTALLFOLDER]BeamNG_LevelCleanUp.exe"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="CleanUpShortcut" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\BeamNG_LevelCleanUp" Name="installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>
    
    <Component Id="DesktopShortcut" Guid="B2C3D4E5-F6A7-8901-B2C3-D4E5F6A78901" Directory="DesktopFolder" Bitness="always64">
      <Shortcut Id="ApplicationDesktopShortcut"
                Name="BeamNG Mapping Tools"
                Description="Tools for BeamNG.drive map building with GeoTIFF support"
                Target="[INSTALLFOLDER]BeamNG_LevelCleanUp.exe"
                WorkingDirectory="INSTALLFOLDER" />
      <RegistryValue Root="HKCU" Key="Software\BeamNG_LevelCleanUp" Name="desktopshortcut" Type="integer" Value="1" KeyPath="yes" />
    </Component>
    
    <!-- Component for registry tracking and cleanup -->
    <Component Id="AppDataCleanupComponent" Guid="E4F5A6B7-C8D9-0123-E4F5-A6B7C8D90124" Directory="INSTALLFOLDER" Bitness="always64">
      <RegistryValue Root="HKCU" Key="Software\BeamNG_LevelCleanUp" Name="AppDataTracking" Type="string" Value="[LocalAppDataFolder]" KeyPath="yes" />
      
      <!-- Remove registry key on uninstall -->
      <RemoveRegistryKey Root="HKCU" Key="Software\BeamNG_LevelCleanUp" Action="removeOnUninstall" />
    </Component>
  </Fragment>

  <!-- Harvest all files from the publish output (excluding the main exe which is defined separately) -->
  <Fragment>
    <ComponentGroup Id="AppComponents" Directory="INSTALLFOLDER">
      <Files Include="..\BeamNG_LevelCleanUp\bin\Release\net9.0-windows10.0.17763.0\win-x64\publish\**">
        <Exclude Files="..\BeamNG_LevelCleanUp\bin\Release\net9.0-windows10.0.17763.0\win-x64\publish\BeamNG_LevelCleanUp.exe" />
      </Files>
    </ComponentGroup>
  </Fragment>

</Wix>

